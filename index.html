<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadow Root - النظام السري</title>
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #0f3460;
            --system: #e94560;
            --dark: #0d0d1a;
            --light: #f1f1f1;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #e74c3c;
            --hacker-green: #00ff41;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --glow: 0 0 10px rgba(0, 255, 65, 0.5);
            
            /* ألوان الرتب الجديدة */
            --rank-d: #95a5a6;
            --rank-c: #3498db;
            --rank-b: #9b59b6;
            --rank-a: #e74c3c;
            --rank-s: #f1c40f;
            --rank-system: #e94560;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }

        body {
            background: linear-gradient(135deg, var(--dark) 0%, #000 100%);
            color: var(--light);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* تأثيرات النيون */
        .neon-text {
            color: var(--hacker-green);
            text-shadow: 0 0 5px var(--hacker-green), 0 0 10px var(--hacker-green);
        }

        .neon-border {
            border: 1px solid var(--hacker-green);
            box-shadow: 0 0 5px var(--hacker-green), inset 0 0 5px var(--hacker-green);
        }

        /* شريط اللغة */
        .language-switcher {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(26, 26, 46, 0.9);
            border-radius: 5px;
            padding: 8px 12px;
            border: 1px solid rgba(0, 255, 65, 0.3);
        }

        .language-switcher select {
            background: rgba(0, 0, 0, 0.5);
            color: var(--hacker-green);
            border: 1px solid rgba(0, 255, 65, 0.3);
            border-radius: 3px;
            padding: 5px;
            font-size: 14px;
        }

        /* شاشة تسجيل الدخول المعدلة */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%230d0d1a"/><path d="M0 0L100 100M100 0L0 100" stroke="%23000" stroke-width="1"/></svg>');
            position: relative;
        }

        .login-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 255, 65, 0.05) 0px,
                rgba(0, 255, 65, 0.05) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
        }

        .login-form {
            background: rgba(26, 26, 46, 0.9);
            padding: 40px;
            border-radius: 10px;
            width: 450px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0, 255, 65, 0.3);
            position: relative;
            z-index: 1;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--hacker-green);
            text-shadow: 0 0 10px var(--hacker-green);
            font-size: 28px;
            letter-spacing: 2px;
        }

        .login-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.3);
        }

        .login-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            color: #aaa;
            font-weight: bold;
        }

        .login-tab.active {
            color: var(--hacker-green);
            border-bottom: 2px solid var(--hacker-green);
            text-shadow: 0 0 5px var(--hacker-green);
        }

        .login-content {
            display: none;
        }

        .login-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--hacker-green);
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(0, 255, 65, 0.3);
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.5);
            color: var(--hacker-green);
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--hacker-green);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 16px;
        }

        .btn-primary {
            background: var(--hacker-green);
            color: #000;
            width: 100%;
        }

        .btn-primary:hover {
            background: #00cc33;
            box-shadow: 0 0 15px var(--hacker-green);
        }

        .login-hint {
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
            color: #666;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        /* الشريط الجانبي المعدل */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--primary) 0%, var(--dark) 100%);
            padding: 20px;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            transition: all 0.3s;
            border-right: 1px solid rgba(0, 255, 65, 0.2);
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
        }

        .logo h1 {
            color: var(--hacker-green);
            font-size: 26px;
            text-shadow: 0 0 10px var(--hacker-green);
            letter-spacing: 3px;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 65, 0.2);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            font-weight: bold;
            color: white;
            font-size: 18px;
            border: 2px solid;
        }

        /* ألوان الرتب الجديدة */
        .avatar-d { 
            background: linear-gradient(45deg, var(--rank-d), #7f8c8d);
            border-color: var(--rank-d);
        }
        .avatar-c { 
            background: linear-gradient(45deg, var(--rank-c), #2980b9);
            border-color: var(--rank-c);
        }
        .avatar-b { 
            background: linear-gradient(45deg, var(--rank-b), #8e44ad);
            border-color: var(--rank-b);
        }
        .avatar-a { 
            background: linear-gradient(45deg, var(--rank-a), #c0392b);
            border-color: var(--rank-a);
        }
        .avatar-s { 
            background: linear-gradient(45deg, var(--rank-s), #d35400);
            border-color: var(--rank-s);
        }
        .avatar-system { 
            background: linear-gradient(45deg, var(--rank-system), #8e44ad);
            border-color: var(--rank-system);
            box-shadow: 0 0 15px var(--rank-system);
        }

        .ranks-list {
            margin-top: 20px;
        }

        .rank-category {
            margin-bottom: 25px;
        }

        .rank-category h3 {
            color: var(--hacker-green);
            margin-bottom: 12px;
            font-size: 16px;
            text-shadow: 0 0 5px var(--hacker-green);
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
        }

        .rank-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .rank-item:hover {
            background: rgba(0, 255, 65, 0.1);
            border-color: rgba(0, 255, 65, 0.3);
            transform: translateX(-5px);
        }

        .rank-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }

        /* ألوان الرتب الجديدة */
        .rank-d { background-color: var(--rank-d); box-shadow: 0 0 5px var(--rank-d); }
        .rank-c { background-color: var(--rank-c); box-shadow: 0 0 5px var(--rank-c); }
        .rank-b { background-color: var(--rank-b); box-shadow: 0 0 5px var(--rank-b); }
        .rank-a { background-color: var(--rank-a); box-shadow: 0 0 5px var(--rank-a); }
        .rank-s { background-color: var(--rank-s); box-shadow: 0 0 5px var(--rank-s); }
        .rank-system { 
            background-color: var(--rank-system); 
            box-shadow: 0 0 10px var(--rank-system);
            animation: pulse-gold 2s infinite;
        }

        @keyframes pulse-gold {
            0% { box-shadow: 0 0 5px var(--rank-system); }
            50% { box-shadow: 0 0 15px var(--rank-system), 0 0 20px gold; }
            100% { box-shadow: 0 0 5px var(--rank-system); }
        }

        /* المحتوى الرئيسي المعدل */
        .main-content {
            flex: 1;
            margin-right: 280px;
            padding: 25px;
            transition: all 0.3s;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%230d0d1a"/><path d="M0 0L100 100M100 0L0 100" stroke="%23000" stroke-width="1"/></svg>');
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
        }

        .header h2 {
            color: var(--hacker-green);
            text-shadow: 0 0 10px var(--hacker-green);
            font-size: 24px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .broadcast-btn {
            background: var(--system);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .broadcast-btn:hover {
            background: #d63031;
            box-shadow: 0 0 10px var(--system);
        }

        .secret-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }

        .secret-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--accent);
        }

        .btn-logout {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 10px 20px;
        }

        .btn-logout:hover {
            background: var(--danger);
            color: white;
            box-shadow: 0 0 10px var(--danger);
        }

        /* unread badges */
        .unread-badge {
            display: inline-block;
            background: var(--system);
            color: #000;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
            vertical-align: middle;
        }

        .tab-unread {
            display: inline-block;
            min-width: 18px;
            text-align: center;
            background: var(--accent);
            color: #fff;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 6px;
        }

        /* التبويبات المعدلة */
        .tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            transition: all 0.3s;
            color: #aaa;
            font-weight: bold;
            position: relative;
        }

        .tab.active {
            color: var(--hacker-green);
            text-shadow: 0 0 5px var(--hacker-green);
        }

        .tab.active::after {
            content: "";
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--hacker-green);
            box-shadow: 0 0 10px var(--hacker-green);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* نمط الدردشة المعدل */
        .chat-container {
            background: rgba(26, 26, 46, 0.7);
            border-radius: 10px;
            padding: 20px;
            height: 500px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(0, 255, 65, 0.2);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 65, 0.1);
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            position: relative;
            border-left: 4px solid var(--secondary);
            transition: all 0.3s;
        }

        .message:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        /* تخصيص تصميم الرسائل حسب الرتبة */
        .message.d {
            border-left-color: var(--rank-d);
            background: linear-gradient(45deg, rgba(149, 165, 166, 0.1), rgba(0, 0, 0, 0.3));
        }

        .message.c {
            border-left-color: var(--rank-c);
            background: linear-gradient(45deg, rgba(52, 152, 219, 0.1), rgba(0, 0, 0, 0.3));
        }

        .message.b {
            border-left-color: var(--rank-b);
            background: linear-gradient(45deg, rgba(155, 89, 182, 0.1), rgba(0, 0, 0, 0.3));
        }

        .message.a {
            border-left-color: var(--rank-a);
            background: linear-gradient(45deg, rgba(231, 76, 60, 0.1), rgba(0, 0, 0, 0.3));
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .message.s {
            border-left-color: var(--rank-s);
            background: linear-gradient(45deg, rgba(241, 196, 15, 0.1), rgba(0, 0, 0, 0.3));
            border: 1px solid rgba(241, 196, 15, 0.3);
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.2);
        }

        .message.system {
            border-left-color: var(--rank-system);
            background: linear-gradient(45deg, rgba(233, 69, 96, 0.2), rgba(0, 0, 0, 0.4));
            border: 1px solid rgba(233, 69, 96, 0.5);
            box-shadow: 0 0 15px rgba(233, 69, 96, 0.3);
            animation: pulse-system 3s infinite;
        }

        @keyframes pulse-system {
            0% { box-shadow: 0 0 10px rgba(233, 69, 96, 0.3); }
            50% { box-shadow: 0 0 20px rgba(233, 69, 96, 0.5), 0 0 30px gold; }
            100% { box-shadow: 0 0 10px rgba(233, 69, 96, 0.3); }
        }

        .message.banned {
            opacity: 0.6;
            border-left-color: var(--danger);
            background: linear-gradient(45deg, rgba(231, 76, 60, 0.1), rgba(0, 0, 0, 0.3));
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 8px;
            color: #aaa;
        }

        .message-sender {
            font-weight: bold;
        }

        /* ألوان المرسلين حسب الرتبة */
        .sender-d { 
            color: var(--rank-d); 
        }
        .sender-c { 
            color: var(--rank-c); 
        }
        .sender-b { 
            color: var(--rank-b); 
        }
        .sender-a { 
            color: var(--rank-a); 
            text-shadow: 0 0 5px var(--rank-a);
        }
        .sender-s { 
            color: var(--rank-s); 
            text-shadow: 0 0 5px var(--rank-s);
        }
        .sender-system { 
            color: var(--rank-system); 
            text-shadow: 0 0 10px var(--rank-system), 0 0 15px gold;
            animation: text-glow 2s infinite;
        }

        @keyframes text-glow {
            0% { text-shadow: 0 0 5px var(--rank-system); }
            50% { text-shadow: 0 0 15px var(--rank-system), 0 0 20px gold; }
            100% { text-shadow: 0 0 5px var(--rank-system); }
        }

        .message-actions {
            position: absolute;
            top: 8px;
            left: 8px;
            display: none;
            gap: 5px;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .delete-btn, .ban-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .delete-btn {
            color: var(--danger);
            background: rgba(231, 76, 60, 0.2);
        }

        .delete-btn:hover {
            background: rgba(231, 76, 60, 0.4);
        }

        .ban-btn {
            color: var(--warning);
            background: rgba(243, 156, 18, 0.2);
        }

        .ban-btn:hover {
            background: rgba(243, 156, 18, 0.4);
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid rgba(0, 255, 65, 0.3);
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.5);
            color: var(--hacker-green);
            font-size: 16px;
            transition: all 0.3s;
        }

        .chat-input input:focus {
            outline: none;
            border-color: var(--hacker-green);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .chat-input button {
            padding: 12px 20px;
            background: var(--hacker-green);
            border: none;
            border-radius: 5px;
            color: #000;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .chat-input button:hover {
            background: #00cc33;
            box-shadow: 0 0 15px var(--hacker-green);
        }

        /* الدردشة المظلمة المعدلة */
        .dark-chat-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .option-card {
            background: rgba(26, 26, 46, 0.7);
            padding: 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(0, 255, 65, 0.2);
        }

        .option-card:hover {
            background: rgba(0, 255, 65, 0.1);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .option-card h3 {
            margin-bottom: 10px;
            color: var(--hacker-green);
            text-shadow: 0 0 5px var(--hacker-green);
        }

        .option-card p {
            color: #aaa;
            font-size: 14px;
        }

        .dark-chat-room {
            display: none;
            margin-top: 20px;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 65, 0.2);
        }

        .room-header h3 {
            color: var(--hacker-green);
            text-shadow: 0 0 5px var(--hacker-green);
        }

        /* نمط الإدارة المعدل */
        .admin-panel {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .admin-card {
            background: rgba(26, 26, 46, 0.7);
            padding: 25px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 65, 0.2);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .admin-card h3 {
            margin-bottom: 20px;
            color: var(--hacker-green);
            text-shadow: 0 0 5px var(--hacker-green);
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--hacker-green);
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(0, 255, 65, 0.3);
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.5);
            color: var(--hacker-green);
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--hacker-green);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            box-shadow: 0 0 10px var(--danger);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #00a085;
            box-shadow: 0 0 10px var(--success);
        }

        .btn-warning {
            background: var(--warning);
            color: #000;
        }

        .btn-warning:hover {
            background: #f1c40f;
            box-shadow: 0 0 10px var(--warning);
        }

        .btn-system {
            background: var(--system);
            color: white;
        }

        .btn-system:hover {
            background: #d63031;
            box-shadow: 0 0 10px var(--system);
        }

        /* الميزات السرية */
        .secret-features {
            display: none;
            margin-top: 30px;
        }

        /* نمط المراسلة الخاصة */
        .private-message-container {
            display: flex;
            height: 500px;
            gap: 20px;
        }

        .private-users-list {
            width: 250px;
            background: rgba(26, 26, 46, 0.7);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(0, 255, 65, 0.2);
            overflow-y: auto;
        }

        .private-user-item {
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .private-user-item:hover {
            background: rgba(0, 255, 65, 0.1);
            border-color: rgba(0, 255, 65, 0.3);
        }

        .private-user-item.active {
            background: rgba(0, 255, 65, 0.2);
            border-color: var(--hacker-green);
        }

        .private-chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* تأثيرات النظام */
        .system-glitch {
            animation: glitch 1s infinite;
        }

        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        .special-features {
            background: linear-gradient(45deg, rgba(233, 69, 96, 0.2), rgba(0, 255, 65, 0.2));
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* التكيف مع الشاشات الصغيرة */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-right: 0;
            }
            
            body {
                flex-direction: column;
            }
            
            .private-message-container {
                flex-direction: column;
            }
            
            .private-users-list {
                width: 100%;
                height: 200px;
            }
            
            .language-switcher {
                top: 10px;
                left: 10px;
            }
        }

        /* تأثيرات إضافية */
        .hacker-terminal {
            font-family: 'Courier New', monospace;
            background: #000;
            color: var(--hacker-green);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid var(--hacker-green);
            box-shadow: 0 0 10px var(--hacker-green);
            overflow-y: auto;
            max-height: 200px;
        }

        .terminal-line {
            margin-bottom: 5px;
        }

        .terminal-prompt {
            color: var(--hacker-green);
        }

        .typewriter {
            overflow: hidden;
            border-right: 2px solid var(--hacker-green);
            white-space: nowrap;
            margin: 0 auto;
            animation: typing 3.5s steps(40, end), blink-caret 0.75s step-end infinite;
        }

        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: var(--hacker-green) }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 65, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 65, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 65, 0); }
        }

        /* نمط الدردشات المظلمة */
        .dark-chats-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-close {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .room-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary);
        }

        .room-header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .room-messages {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .room-message {
            padding: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
        }

        /* إخفاء تبويب الإدارة عن المستخدمين العاديين */
        .admin-tab {
            display: none !important;
        }

        .admin-tab.visible {
            display: block !important;
        }

        /* تبويب المراسلة الخاصة */
        .private-tab {
            display: none !important;
        }

        .private-tab.visible {
            display: block !important;
        }

        /* أنماط إضافية لنظام التوثيق والنقاط */
        
        /* تبويب التوثيق */
        .verification-tab {
            display: none !important;
        }
        
        .verification-tab.visible {
            display: block !important;
        }
        
        /* تبويب النقاط */
        .points-tab {
            display: none !important;
        }
        
        .points-tab.visible {
            display: block !important;
        }
        
        /* تبويب الأرشيف */
        .archive-tab {
            display: none !important;
        }
        
        .archive-tab.visible {
            display: block !important;
        }
        
        /* نماذج التوثيق */
        .verification-form {
            background: rgba(26, 26, 46, 0.7);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 255, 65, 0.2);
        }
        
        .project-card {
            background: rgba(26, 26, 46, 0.7);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid rgba(0, 255, 65, 0.2);
            position: relative;
        }
        
        .project-card.verified {
            border-color: var(--success);
            box-shadow: 0 0 10px rgba(0, 184, 148, 0.3);
        }
        
        .verified-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--success);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .project-images {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            overflow-x: auto;
        }
        
        .project-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid rgba(0, 255, 65, 0.3);
        }
        
        /* نظام النقاط */
        .points-display {
            background: rgba(26, 26, 46, 0.7);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 255, 65, 0.2);
            text-align: center;
        }
        
        .points-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--hacker-green);
            text-shadow: 0 0 10px var(--hacker-green);
        }
        
        .points-level {
            margin-top: 10px;
            font-size: 14px;
            color: #aaa;
        }
        
        .points-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px;
        }
        
        .badge-1 { background: linear-gradient(45deg, #95a5a6, #7f8c8d); }
        .badge-2 { background: linear-gradient(45deg, #3498db, #2980b9); }
        .badge-3 { background: linear-gradient(45deg, #9b59b6, #8e44ad); }
        .badge-4 { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .badge-5 { background: linear-gradient(45deg, #f1c40f, #d35400); }
        .badge-6 { background: linear-gradient(45deg, #e94560, #8e44ad); box-shadow: 0 0 10px var(--rank-system); }
        
        .leaderboard {
            margin-top: 20px;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            border: 1px solid rgba(0, 255, 65, 0.1);
        }
        
        .leaderboard-rank {
            font-weight: bold;
            color: var(--hacker-green);
        }
        
        /* تحسين الميزات */
        .features-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .feature-item {
            background: rgba(26, 26, 46, 0.7);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 65, 0.2);
            text-align: center;
        }
        
        .feature-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        /* تحسين التوافق */
        @media (max-width: 768px) {
            .features-list {
                grid-template-columns: 1fr;
            }
            
            .project-images {
                flex-wrap: wrap;
            }
            
            .project-image {
                width: 80px;
                height: 80px;
            }
        }
        
        /* تحسين شارة المستخدم في الدردشة */
        .user-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-right: 5px;
            font-weight: bold;
        }

        /* تصميم البث العام المميز */
        .broadcast-message {
            background: linear-gradient(45deg, rgba(233, 69, 96, 0.3), rgba(0, 255, 65, 0.2)) !important;
            border: 2px solid var(--system) !important;
            box-shadow: 0 0 20px rgba(233, 69, 96, 0.5) !important;
            animation: broadcast-pulse 2s infinite !important;
        }

        @keyframes broadcast-pulse {
            0% { box-shadow: 0 0 10px rgba(233, 69, 96, 0.5); }
            50% { box-shadow: 0 0 25px rgba(233, 69, 96, 0.8), 0 0 35px gold; }
            100% { box-shadow: 0 0 10px rgba(233, 69, 96, 0.5); }
        }

        .broadcast-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            color: var(--system);
            text-shadow: 0 0 10px var(--system);
        }

        /* تصميم الأرشيف */
        .archive-container {
            background: rgba(26, 26, 46, 0.7);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(0, 255, 65, 0.2);
        }

        .archive-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .archive-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
        }

        .archive-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        /* ميزات النظام المتقدمة */
        .system-features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .system-feature-card {
            background: rgba(26, 26, 46, 0.7);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 65, 0.2);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .system-feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            border-color: var(--system);
        }

        .system-feature-icon {
            font-size: 32px;
            margin-bottom: 15px;
            color: var(--system);
        }

        /* تأثيرات النقاط في الدردشة */
        .message-with-points {
            position: relative;
        }

        .points-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        /* تصميم التوثيق المتقدم */
        .verification-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(0, 255, 65, 0.2);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--hacker-green);
        }

        .stat-label {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- شريط تبديل اللغة -->
    <div class="language-switcher">
        <select id="languageSelect">
            <option value="ar">العربية</option>
            <option value="en">English</option>
            <option value="fr">Français</option>
            <option value="es">Español</option>
            <option value="de">Deutsch</option>
        </select>
    </div>

    <!-- شاشة تسجيل الدخول -->
    <div id="loginScreen" class="login-container">
        <div class="login-form">
            <h2 class="typewriter" data-i18n="app_title">Shadow Root</h2>
            
            <div class="login-tabs">
                <div class="login-tab active" data-tab="login" data-i18n="login_tab">الدخول للنظام</div>
                <div class="login-tab" data-tab="register" data-i18n="register_tab">انضمام جديد</div>
            </div>
            
            <!-- تسجيل الدخول -->
            <div class="login-content active" id="loginContent">
                <div class="form-group">
                    <label for="loginUsername" data-i18n="username_label">المعرف السري</label>
                    <input type="text" id="loginUsername" placeholder="أدخل المعرف الخاص بك" data-i18n-placeholder="username_placeholder">
                </div>
                <div class="form-group">
                    <label for="loginPassword" data-i18n="password_label">كلمة المرور</label>
                    <input type="password" id="loginPassword" placeholder="أدخل كلمة المرور السرية" data-i18n-placeholder="password_placeholder">
                </div>
                <button id="loginBtn" class="btn btn-primary" data-i18n="login_button">تفعيل الدخول</button>
                <div class="login-hint" data-i18n="login_hint">
                    النظام محمي بتقنيات التشفير المتقدمة
                </div>
            </div>
            
            <!-- إنشاء حساب -->
            <div class="login-content" id="registerContent">
                <div class="form-group">
                    <label for="registerUsername" data-i18n="choose_username">اختر معرفًا سريًا</label>
                    <input type="text" id="registerUsername" placeholder="لا يمكن استخدام: 00-09" data-i18n-placeholder="username_hint">
                    <div style="font-size: 11px; color: #666; margin-top: 5px;" data-i18n="username_reserved">
                        المعرفات 00-09 محجوزة للنظام والقيادة
                    </div>
                </div>
                <div class="form-group">
                    <label for="registerPassword" data-i18n="choose_password">كلمة المرور السرية</label>
                    <input type="password" id="registerPassword" placeholder="اختر كلمة مرور قوية" data-i18n-placeholder="password_hint">
                </div>
                <div class="form-group">
                    <label for="registerConfirmPassword" data-i18n="confirm_password">تأكيد كلمة المرور</label>
                    <input type="password" id="registerConfirmPassword" placeholder="أعد إدخال كلمة المرور" data-i18n-placeholder="confirm_password_placeholder">
                </div>
                <button id="registerBtn" class="btn btn-success" data-i18n="register_button">إنشاء حساب جديد</button>
            </div>
        </div>
    </div>

    <!-- الواجهة الرئيسية -->
    <div id="mainApp" style="display: none; width: 100%;">
        <!-- الشريط الجانبي -->
        <div class="sidebar">
            <div class="logo">
                <h1 data-i18n="app_title">Shadow Root</h1>
                <div style="font-size: 12px; color: #666; margin-top: 5px;" data-i18n="app_subtitle">النظام السري</div>
            </div>
            
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">SR</div>
                <div>
                    <div id="userName" class="neon-text">المستخدم</div>
                    <div id="userRank" style="font-size: 12px; color: #aaa;">الرتبة</div>
                    <div id="userPoints" style="font-size: 10px; color: var(--hacker-green);">النقاط: 0</div>
                    <div id="userStatus" style="font-size: 10px; color: #aaa;"></div>
                </div>
            </div>
            
            <div class="ranks-list">
                <div class="rank-category">
                    <h3 data-i18n="leadership_ranks">القيادة العليا</h3>
                    <div class="rank-item">
                        <div class="rank-color rank-system"></div>
                        <div data-i18n="rank_system">SYSTEM</div>
                    </div>
                    <div class="rank-item">
                        <div class="rank-color rank-s"></div>
                        <div data-i18n="rank_s">S</div>
                    </div>
                </div>
                
                <div class="rank-category">
                    <h3 data-i18n="programmer_ranks">فريق المبرمجين</h3>
                    <div class="rank-item">
                        <div class="rank-color rank-a"></div>
                        <div data-i18n="rank_a">A</div>
                    </div>
                    <div class="rank-item">
                        <div class="rank-color rank-b"></div>
                        <div data-i18n="rank_b">B</div>
                    </div>
                    <div class="rank-item">
                        <div class="rank-color rank-c"></div>
                        <div data-i18n="rank_c">C</div>
                    </div>
                    <div class="rank-item">
                        <div class="rank-color rank-d"></div>
                        <div data-i18n="rank_d">D</div>
                    </div>
                </div>
            </div>

            <!-- الميزات السرية - تظهر للمدير والنظام فقط -->
            <div class="secret-features" id="secretFeatures">
                <div class="rank-category">
                    <h3 data-i18n="your_features">ميزات رتبتك</h3>
                    <div class="rank-item" onclick="showAdminTools()" id="adminToolsItem">
                        <div data-i18n="admin_tools">🛠️ أدوات التحكم</div>
                    </div>
                    <div class="rank-item" onclick="viewAllDarkChats()" id="darkChatsItem">
                        <div data-i18n="view_dark_chats">🔍 الدردشات المظلمة</div>
                    </div>
                    <div class="rank-item" onclick="systemBroadcast()" id="broadcastItem">
                        <div data-i18n="system_broadcast">📢 البث العام</div>
                    </div>
                    <div class="rank-item" onclick="showSystemTools()" id="systemToolsItem">
                        <div data-i18n="system_tools">⚡ أدوات النظام</div>
                    </div>
                    <div class="rank-item" onclick="showVerificationTab()" id="verificationItem">
                        <div data-i18n="project_verification">✅ توثيق المشاريع</div>
                    </div>
                    <div class="rank-item" onclick="showPointsTab()" id="pointsItem">
                        <div data-i18n="points_system">🏆 نظام النقاط</div>
                    </div>
                    <div class="rank-item" onclick="showArchiveTab()" id="archiveItem">
                        <div data-i18n="system_archive">📚 أرشيف النظام</div>
                    </div>
                    <div class="rank-item" onclick="showEarthFeatures()" id="earthFeaturesItem">
                        <div data-i18n="earth_features">🌍 ميزات الأرض</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- المحتوى الرئيسي -->
        <div class="main-content">
            <div class="header">
                <h2 data-i18n="team_title">فريق Shadow Root</h2>
                <div class="header-controls">
                    <!-- زر البث العام يظهر للنظام فقط -->
                    <button id="broadcastBtn" class="broadcast-btn" style="display: none;" data-i18n="broadcast_button">📢 بث عام</button>
                    <!-- زر الميزات السرية يظهر للمدير والنظام فقط -->
                    <button id="secretBtn" class="secret-btn" title="الميزات السرية" style="display: none;">⚡</button>
                    <button id="exportBackupBtn" class="btn btn-primary" title="تصدير نسخة احتياطية">تصدير نسخة</button>
                    <input type="file" id="importBackupInput" style="display:none;" accept="application/json">
                    <button id="importBackupBtn" class="btn btn-warning">استيراد نسخة</button>
                    <button id="logoutBtn" class="btn btn-logout" data-i18n="logout_button">إنهاء الجلسة</button>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="chat" data-i18n="public_chat">الدردشة العامة</div>
                <div class="tab" data-tab="darkChat" data-i18n="dark_chat">الدردشة المظلمة</div>
                <div class="tab" data-tab="members" data-i18n="members_tab">الأعضاء</div>
                <div class="tab private-tab" data-tab="private" data-i18n="private_messages">المراسلة الخاصة</div>
                <!-- تبويب التوثيق الجديد -->
                <div class="tab verification-tab" data-tab="verification" data-i18n="project_verification">توثيق المشاريع</div>
                <!-- تبويب النقاط الجديد -->
                <div class="tab points-tab" data-tab="points" data-i18n="points_system">نظام النقاط</div>
                <!-- تبويب الأرشيف الجديد -->
                <div class="tab archive-tab" data-tab="archive" data-i18n="system_archive">أرشيف النظام</div>
                <!-- تبويب الإدارة يظهر للمدير والنظام فقط -->
                <div class="tab admin-tab" data-tab="admin" id="adminTabBtn" data-i18n="admin_panel">لوحة التحكم</div>
            </div>
            
            <!-- محتوى الدردشة العامة -->
            <div class="tab-content active" id="chatTab">
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <!-- الرسائل تظهر هنا -->
                    </div>
                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="اكتب رسالتك هنا..." data-i18n-placeholder="message_placeholder">
                        <button id="sendMessageBtn" data-i18n="send_button">إرسال</button>
                    </div>
                </div>
            </div>
            
            <!-- محتوى الدردشة المظلمة -->
            <div class="tab-content" id="darkChatTab">
                <div class="dark-chat-options">
                    <div class="option-card" id="createRoomBtn">
                        <h3 data-i18n="create_room">إنشاء غرفة جديدة</h3>
                        <p data-i18n="create_room_desc">أنشئ غرفة دردشة مؤقتة برمز سري</p>
                    </div>
                    <div class="option-card" id="joinRoomBtn">
                        <h3 data-i18n="join_room">الانضمام إلى غرفة</h3>
                        <p data-i18n="join_room_desc">ادخل رمز الغرفة للانضمام إلى دردشة مؤقتة</p>
                    </div>
                </div>
                
                <div id="darkChatRoom" class="dark-chat-room">
                    <div class="chat-container">
                        <div class="room-header">
                            <h3 data-i18n="dark_chat_room">الدردشة المظلمة - الغرفة: <span id="roomCodeDisplay"></span></h3>
                            <button id="leaveRoomBtn" class="btn btn-danger" data-i18n="leave_room">مغادرة الغرفة</button>
                        </div>
                        <div class="chat-messages" id="darkChatMessages">
                            <!-- رسائل الدردشة المظلمة تظهر هنا -->
                        </div>
                        <div class="chat-input">
                            <input type="text" id="darkMessageInput" placeholder="اكتب رسالتك هنا..." data-i18n-placeholder="message_placeholder">
                            <button id="sendDarkMessageBtn" data-i18n="send_button">إرسال</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- محتوى الأعضاء -->
            <div class="tab-content" id="membersTab">
                <div class="admin-panel" id="membersList">
                    <!-- قائمة الأعضاء تظهر هنا -->
                </div>
            </div>

            <!-- محتوى المراسلة الخاصة -->
            <div class="tab-content" id="privateTab">
                <div class="private-message-container">
                    <div class="private-users-list" id="privateUsersList">
                        <!-- قائمة المستخدمين للمراسلة الخاصة -->
                    </div>
                    <div class="private-chat-area">
                        <div class="chat-container">
                            <div class="chat-messages" id="privateMessages">
                                <!-- رسائل المراسلة الخاصة تظهر هنا -->
                            </div>
                            <div class="chat-input">
                                <input type="text" id="privateMessageInput" placeholder="اكتب رسالتك الخاصة..." data-i18n-placeholder="private_message_placeholder">
                                <button id="sendPrivateMessageBtn" data-i18n="send_button">إرسال</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- محتوى التوثيق الجديد -->
            <div class="tab-content" id="verificationTab">
                <div class="admin-panel">
                    <div class="admin-card">
                        <h3 data-i18n="verify_project">توثيق مشروع جديد</h3>
                        <div class="form-group">
                            <label for="projectName" data-i18n="project_name">اسم المشروع</label>
                            <input type="text" id="projectName" placeholder="أدخل اسم المشروع" data-i18n-placeholder="project_name_placeholder">
                        </div>
                        <div class="form-group">
                            <label for="projectDescription" data-i18n="project_description">وصف المشروع</label>
                            <textarea id="projectDescription" rows="4" placeholder="أدخل وصف المشروع" data-i18n-placeholder="project_description_placeholder" style="width: 100%; padding: 12px 15px; border: 1px solid rgba(0, 255, 65, 0.3); border-radius: 5px; background: rgba(0, 0, 0, 0.5); color: var(--hacker-green); font-size: 16px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="projectImages" data-i18n="project_images">صور المشروع</label>
                            <input type="file" id="projectImages" multiple accept="image/*">
                            <div style="font-size: 12px; color: #666; margin-top: 5px;" data-i18n="project_images_hint">يمكنك رفع عدة صور للمشروع</div>
                        </div>
                        <button id="submitProjectBtn" class="btn btn-primary" data-i18n="submit_project">تقديم للمراجعة</button>
                    </div>
                    
                    <div class="admin-card">
                        <h3 data-i18n="my_projects">مشاريعي</h3>
                        <div id="userProjectsList">
                            <!-- قائمة مشاريع المستخدم تظهر هنا -->
                        </div>
                    </div>
                    <div class="admin-card">
                        <h3>مشاريع موثقة عامة</h3>
                        <div id="verifiedProjectsList">
                            <!-- قائمة المشاريع الموثقة تظهر هنا -->
                        </div>
                    </div>
                    
                    <!-- لوحة مراجعة المشاريع (للسستم والمديرين فقط) -->
                    <div class="admin-card" id="reviewProjectsCard" style="display: none;">
                        <h3 data-i18n="review_projects">مراجعة المشاريع</h3>
                        <div id="pendingProjectsList">
                            <!-- قائمة المشاريع المعلقة تظهر هنا -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- محتوى النقاط الجديد -->
            <div class="tab-content" id="pointsTab">
                <div class="points-display">
                    <div data-i18n="your_points">نقاطك</div>
                    <div class="points-value" id="userPointsValue">0</div>
                    <div class="points-level" id="userLevel">المستوى: مبتدئ</div>
                    <div id="userBadges">
                        <!-- شارات المستخدم تظهر هنا -->
                    </div>
                </div>
                
                <div class="admin-panel">
                    <div class="admin-card">
                        <h3 data-i18n="points_leaderboard">تصنيف النقاط</h3>
                        <div class="leaderboard" id="pointsLeaderboard">
                            <!-- تصنيف النقاط يظهر هنا -->
                        </div>
                    </div>
                    
                    <div class="admin-card">
                        <h3 data-i18n="how_to_earn">كيفية كسب النقاط</h3>
                        <div class="features-list">
                            <div class="feature-item">
                                <div class="feature-icon">💬</div>
                                <div data-i18n="daily_login">الدخول اليومي</div>
                                <div style="color: var(--hacker-green);">+3 نقاط</div>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">🚀</div>
                                <div data-i18n="verified_project">مشروع موثق</div>
                                <div style="color: var(--hacker-green);">+15 نقطة</div>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">💡</div>
                                <div data-i18n="active_participation">مشاركة فعالة</div>
                                <div style="color: var(--hacker-green);">+5 نقاط</div>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">🏆</div>
                                <div data-i18n="special_achievements">إنجازات خاصة</div>
                                <div style="color: var(--hacker-green);">+10 نقاط</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- لوحة إدارة النقاط (للسستم فقط) -->
                    <div class="admin-card" id="managePointsCard" style="display: none;">
                        <h3 data-i18n="manage_points">إدارة النقاط</h3>
                        <div class="form-group">
                            <label for="pointsUserSelect" data-i18n="select_user">اختر المستخدم</label>
                            <select id="pointsUserSelect">
                                <option value="" data-i18n="select_user_option">-- اختر مستخدم --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pointsAmount" data-i18n="points_amount">عدد النقاط</label>
                            <input type="number" id="pointsAmount" placeholder="أدخل عدد النقاط">
                        </div>
                        <button id="addPointsBtn" class="btn btn-success" data-i18n="add_points">إضافة نقاط</button>
                        <button id="removePointsBtn" class="btn btn-danger" data-i18n="remove_points">خصم نقاط</button>
                        <button id="resetPointsBtn" class="btn btn-warning" data-i18n="reset_points">إعادة تعيين</button>
                    </div>
                </div>
            </div>
            
            <!-- محتوى الأرشيف الجديد -->
            <div class="tab-content" id="archiveTab">
                <div class="archive-container">
                    <div class="archive-filters">
                        <select id="archiveType" class="form-group" style="width: auto;">
                            <option value="all">جميع السجلات</option>
                            <option value="dark_chats">الدردشات المظلمة</option>
                            <option value="projects">المشاريع</option>
                            <option value="users">المستخدمين</option>
                            <option value="system">النظام</option>
                        </select>
                        <input type="date" id="archiveDate" class="form-group" style="width: auto;">
                        <button class="btn btn-primary" onclick="loadArchive()" data-i18n="load_archive">تحميل الأرشيف</button>
                    </div>
                    <div id="archiveContent">
                        <!-- محتوى الأرشيف يظهر هنا -->
                    </div>
                </div>
            </div>
            
            <!-- محتوى الإدارة - يظهر للمدير والنظام فقط -->
            <div class="tab-content" id="adminTab">
                <div class="admin-panel">
                    <div class="admin-card">
                        <h3 data-i18n="member_management">إدارة الأعضاء المتقدمة</h3>
                        <div class="form-group">
                            <label for="memberSelect" data-i18n="select_member">اختر العضو</label>
                            <select id="memberSelect">
                                <option value="" data-i18n="select_member_option">-- اختر عضوا --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newName" data-i18n="change_username">تغيير اسم المستخدم</label>
                            <input type="text" id="newName" placeholder="اسم المستخدم الجديد" data-i18n-placeholder="new_username_placeholder">
                        </div>
                        <div class="form-group">
                            <label for="rankSelect" data-i18n="change_rank">تغيير الرتبة</label>
                            <select id="rankSelect">
                                <option value="d" data-i18n="rank_d">D</option>
                                <option value="c" data-i18n="rank_c">C</option>
                                <option value="b" data-i18n="rank_b">B</option>
                                <option value="a" data-i18n="rank_a">A</option>
                                <option value="s" data-i18n="rank_s">S</option>
                                <option value="system" data-i18n="rank_system">SYSTEM</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="banDuration" data-i18n="ban_duration">حظر المستخدم (أيام)</label>
                            <input type="number" id="banDuration" placeholder="عدد أيام الحظر (0 لإلغاء الحظر)" data-i18n-placeholder="ban_duration_placeholder">
                        </div>
                        <button id="updateMemberBtn" class="btn btn-primary" data-i18n="apply_changes">تطبيق التغييرات</button>
                        <button id="kickUserBtn" class="btn btn-warning" data-i18n="kick_user">طرد المستخدم</button>
                        <button id="banUserBtn" class="btn btn-danger" data-i18n="ban_user">حظر المستخدم</button>
                        <button id="removeUserBtn" class="btn btn-danger" data-i18n="remove_user">حذف نهائي</button>
                    </div>
                    
                    <div class="admin-card">
                        <h3 data-i18n="system_control">التحكم بالنظام</h3>
                        <button id="clearAllBtn" class="btn btn-danger" style="margin-bottom: 10px;" data-i18n="clear_messages">مسح جميع الرسائل</button>
                        <button id="exportDataBtn" class="btn btn-success" style="margin-bottom: 10px;" data-i18n="export_data">تصدير البيانات</button>
                        <button id="systemInfoBtn" class="btn btn-primary" style="margin-bottom: 10px;" data-i18n="system_info">معلومات النظام</button>
                        <button id="viewAllChatsBtn" class="btn btn-warning" data-i18n="view_all_chats">عرض جميع الدردشات المظلمة</button>
                        <button id="deleteAllUsersBtn" class="btn btn-danger" style="margin-top: 10px;" data-i18n="delete_all_users">حذف جميع الحسابات</button>
                    </div>
                    
                    <div class="admin-card">
                        <h3 data-i18n="system_stats">إحصائيات النظام</h3>
                        <div id="systemStats" class="hacker-terminal">
                            <!-- إحصائيات النظام -->
                        </div>
                    </div>

                    <!-- قائمة الميزات حسب الرتبة -->
                    <div class="admin-card">
                        <h3>ميزات الرتبة الحالية</h3>
                        <div id="rankFeaturesList" style="padding:10px; color:#ddd;">
                            <!-- سيتم ملء الميزات هنا بواسطة الجافاسكربت -->
                        </div>
                    </div>

                    <!-- طلبات الترقيات المعلقة -->
                    <div class="admin-card" id="pendingPromotionsCard">
                        <h3>طلبات الترقيات المعلقة</h3>
                        <div id="pendingPromotionsList">
                            <!-- قائمة الطلبات تظهر هنا -->
                        </div>
                    </div>

                    <!-- أدوات النظام الخاصة - تظهر للنظام فقط -->
                    <div class="admin-card" id="systemToolsCard" style="display: none;">
                        <h3 class="system-glitch" data-i18n="special_system_tools">أدوات النظام الخاصة 🚀</h3>
                        <div class="system-features-grid">
                            <div class="system-feature-card" onclick="massPromotion()">
                                <div class="system-feature-icon">⬆️</div>
                                <div data-i18n="mass_promotion">ترقية جماعية</div>
                            </div>
                            <div class="system-feature-card" onclick="resetSystem()">
                                <div class="system-feature-icon">🔄</div>
                                <div data-i18n="reset_system">إعادة تعيين</div>
                            </div>
                            <div class="system-feature-card" onclick="createFakeActivity()">
                                <div class="system-feature-icon">🤖</div>
                                <div data-i18n="fake_activity">نشاط وهمي</div>
                            </div>
                            <div class="system-feature-card" onclick="emergencyLockdown()">
                                <div class="system-feature-icon">🔒</div>
                                <div data-i18n="emergency_lockdown">وضع الطوارئ</div>
                            </div>
                            <div class="system-feature-card" onclick="hackMode()">
                                <div class="system-feature-icon">⚡</div>
                                <div data-i18n="hack_mode">وضع الهاكر</div>
                            </div>
                            <div class="system-feature-card" onclick="earthControl()">
                                <div class="system-feature-icon">🌍</div>
                                <div data-i18n="earth_control">تحكم الأرض</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- صفحة عرض الدردشات المظلمة -->
    <div id="darkChatsModal" class="dark-chats-modal">
        <div class="modal-header">
            <h2 data-i18n="dark_chats_log">📋 سجل الدردشات المظلمة</h2>
            <button class="modal-close" onclick="closeDarkChatsModal()" data-i18n="close_button">إغلاق</button>
        </div>
        <div id="darkChatsList">
            <!-- قائمة الدردشات المظلمة تظهر هنا -->
        </div>
    </div>

    <script>
        // بيانات التطبيق الموسعة
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('shadowRootUsers')) || [];
        let messages = JSON.parse(localStorage.getItem('shadowRootMessages')) || [];
    let privateMessages = JSON.parse(localStorage.getItem('shadowRootPrivateMessages')) || [];
    // privateUnread[fromId] = { toId: count }
    let privateUnread = JSON.parse(localStorage.getItem('shadowRootPrivateUnread')) || {};
    // per-user message colors
    let userColors = JSON.parse(localStorage.getItem('shadowRootUserColors')) || {};
        let darkChatRooms = JSON.parse(localStorage.getItem('shadowRootDarkRooms')) || [];
        let projects = JSON.parse(localStorage.getItem('shadowRootProjects')) || [];
    let pendingPromotions = JSON.parse(localStorage.getItem('shadowRootPendingPromotions')) || [];
        let userPoints = JSON.parse(localStorage.getItem('shadowRootUserPoints')) || {};
        let dailyLogin = JSON.parse(localStorage.getItem('shadowRootDailyLogin')) || {};
        let systemArchive = JSON.parse(localStorage.getItem('shadowRootArchive')) || [];
        let currentDarkRoom = null;
        let secretMode = false;
        let selectedPrivateUser = null;
        let currentLanguage = 'ar';

        // الأسماء المحجوبة
        const reservedUsernames = ['00', '01', '02', '03', '04', '05', '06', '07', '08', '09'];

        // صلاحيات الرتب الجديدة الموسعة
        const rankPermissions = {
            'system': ['all', 'earth_control', 'view_archive', 'manage_points', 'view_closed_dark_chats'],
            's': ['manage_users', 'view_reports', 'ban_users', 'delete_messages', 'promote_users', 'view_dark_chats', 'verify_projects'],
            'a': ['manage_juniors', 'view_stats', 'create_rooms', 'join_rooms', 'submit_projects'],
            'b': ['create_rooms', 'join_rooms', 'submit_projects'],
            'c': ['join_rooms', 'submit_projects'],
            'd': ['basic_chat', 'submit_projects']
        };

        // ترجمة النصوص الموسعة
        const translations = {
            'ar': {
                'app_title': 'Shadow Root',
                'app_subtitle': 'النظام السري',
                'login_tab': 'الدخول للنظام',
                'register_tab': 'انضمام جديد',
                'username_label': 'المعرف السري',
                'username_placeholder': 'أدخل المعرف الخاص بك',
                'password_label': 'كلمة المرور',
                'password_placeholder': 'أدخل كلمة المرور السرية',
                'login_button': 'تفعيل الدخول',
                'login_hint': 'النظام محمي بتقنيات التشفير المتقدمة',
                'choose_username': 'اختر معرفًا سريًا',
                'username_hint': 'لا يمكن استخدام: 00-09',
                'username_reserved': 'المعرفات 00-09 محجوزة للنظام والقيادة',
                'choose_password': 'كلمة المرور السرية',
                'password_hint': 'اختر كلمة مرور قوية',
                'confirm_password': 'تأكيد كلمة المرور',
                'confirm_password_placeholder': 'أعد إدخال كلمة المرور',
                'register_button': 'إنشاء حساب جديد',
                'team_title': 'فريق Shadow Root',
                'broadcast_button': '📢 بث عام',
                'logout_button': 'إنهاء الجلسة',
                'public_chat': 'الدردشة العامة',
                'dark_chat': 'الدردشة المظلمة',
                'members_tab': 'الأعضاء',
                'private_messages': 'المراسلة الخاصة',
                'admin_panel': 'لوحة التحكم',
                'message_placeholder': 'اكتب رسالتك هنا...',
                'private_message_placeholder': 'اكتب رسالتك الخاصة...',
                'send_button': 'إرسال',
                'create_room': 'إنشاء غرفة جديدة',
                'create_room_desc': 'أنشئ غرفة دردشة مؤقتة برمز سري',
                'join_room': 'الانضمام إلى غرفة',
                'join_room_desc': 'ادخل رمز الغرفة للانضمام إلى دردشة مؤقتة',
                'dark_chat_room': 'الدردشة المظلمة - الغرفة:',
                'leave_room': 'مغادرة الغرفة',
                'leadership_ranks': 'القيادة العليا',
                'programmer_ranks': 'فريق المبرمجين',
                'rank_system': 'SYSTEM',
                'rank_s': 'S',
                'rank_a': 'A',
                'rank_b': 'B',
                'rank_c': 'C',
                'rank_d': 'D',
                'your_features': 'ميزات رتبتك',
                'admin_tools': '🛠️ أدوات التحكم',
                'view_dark_chats': '🔍 الدردشات المظلمة',
                'system_broadcast': '📢 البث العام',
                'system_tools': '⚡ أدوات النظام',
                'project_verification': '✅ توثيق المشاريع',
                'points_system': '🏆 نظام النقاط',
                'system_archive': '📚 أرشيف النظام',
                'earth_features': '🌍 ميزات الأرض',
                'member_management': 'إدارة الأعضاء المتقدمة',
                'select_member': 'اختر العضو',
                'select_member_option': '-- اختر عضوا --',
                'change_username': 'تغيير اسم المستخدم',
                'new_username_placeholder': 'اسم المستخدم الجديد',
                'change_rank': 'تغيير الرتبة',
                'ban_duration': 'حظر المستخدم (أيام)',
                'ban_duration_placeholder': 'عدد أيام الحظر (0 لإلغاء الحظر)',
                'apply_changes': 'تطبيق التغييرات',
                'kick_user': 'طرد المستخدم',
                'ban_user': 'حظر المستخدم',
                'remove_user': 'حذف نهائي',
                'system_control': 'التحكم بالنظام',
                'clear_messages': 'مسح جميع الرسائل',
                'export_data': 'تصدير البيانات',
                'system_info': 'معلومات النظام',
                'view_all_chats': 'عرض جميع الدردشات المظلمة',
                'delete_all_users': 'حذف جميع الحسابات',
                'system_stats': 'إحصائيات النظام',
                'special_system_tools': 'أدوات النظام الخاصة 🚀',
                'mass_promotion': 'ترقية جماعية',
                'reset_system': 'إعادة تعيين',
                'fake_activity': 'نشاط وهمي',
                'emergency_lockdown': 'وضع الطوارئ',
                'hack_mode': 'وضع الهاكر',
                'earth_control': 'تحكم الأرض',
                'dark_chats_log': '📋 سجل الدردشات المظلمة',
                'close_button': 'إغلاق',
                'verify_project': 'توثيق مشروع جديد',
                'project_name': 'اسم المشروع',
                'project_name_placeholder': 'أدخل اسم المشروع',
                'project_description': 'وصف المشروع',
                'project_description_placeholder': 'أدخل وصف المشروع',
                'project_images': 'صور المشروع',
                'project_images_hint': 'يمكنك رفع عدة صور للمشروع',
                'submit_project': 'تقديم للمراجعة',
                'my_projects': 'مشاريعي',
                'review_projects': 'مراجعة المشاريع',
                'your_points': 'نقاطك',
                'points_leaderboard': 'تصنيف النقاط',
                'how_to_earn': 'كيفية كسب النقاط',
                'daily_login': 'الدخول اليومي',
                'verified_project': 'مشروع موثق',
                'active_participation': 'مشاركة فعالة',
                'special_achievements': 'إنجازات خاصة',
                'manage_points': 'إدارة النقاط',
                'select_user': 'اختر المستخدم',
                'select_user_option': '-- اختر مستخدم --',
                'points_amount': 'عدد النقاط',
                'add_points': 'إضافة نقاط',
                'remove_points': 'خصم نقاط',
                'reset_points': 'إعادة تعيين',
                'project_submitted': 'تم تقديم المشروع بنجاح',
                'project_approved': 'تم توثيق المشروع',
                'project_rejected': 'تم رفض المشروع',
                'points_added': 'تم إضافة النقاط',
                'points_removed': 'تم خصم النقاط',
                'points_reset': 'تم إعادة تعيين النقاط',
                'load_archive': 'تحميل الأرشيف'
            },
            'en': {
                'app_title': 'Shadow Root',
                'app_subtitle': 'Secret System',
                'login_tab': 'Login to System',
                'register_tab': 'New Member',
                'username_label': 'Secret ID',
                'username_placeholder': 'Enter your ID',
                'password_label': 'Password',
                'password_placeholder': 'Enter your secret password',
                'login_button': 'Activate Login',
                'login_hint': 'System protected by advanced encryption',
                'choose_username': 'Choose a secret ID',
                'username_hint': 'Cannot use: 00-09',
                'username_reserved': 'IDs 00-09 reserved for system and leadership',
                'choose_password': 'Secret Password',
                'password_hint': 'Choose a strong password',
                'confirm_password': 'Confirm Password',
                'confirm_password_placeholder': 'Re-enter password',
                'register_button': 'Create New Account',
                'team_title': 'Shadow Root Team',
                'broadcast_button': '📢 Broadcast',
                'logout_button': 'End Session',
                'public_chat': 'Public Chat',
                'dark_chat': 'Dark Chat',
                'members_tab': 'Members',
                'private_messages': 'Private Messages',
                'admin_panel': 'Control Panel',
                'message_placeholder': 'Type your message here...',
                'private_message_placeholder': 'Type your private message...',
                'send_button': 'Send',
                'create_room': 'Create New Room',
                'create_room_desc': 'Create a temporary chat room with secret code',
                'join_room': 'Join Room',
                'join_room_desc': 'Enter room code to join temporary chat',
                'dark_chat_room': 'Dark Chat - Room:',
                'leave_room': 'Leave Room',
                'leadership_ranks': 'High Command',
                'programmer_ranks': 'Programmer Team',
                'rank_system': 'SYSTEM',
                'rank_s': 'S',
                'rank_a': 'A',
                'rank_b': 'B',
                'rank_c': 'C',
                'rank_d': 'D',
                'your_features': 'Your Features',
                'admin_tools': '🛠️ Control Tools',
                'view_dark_chats': '🔍 Dark Chats',
                'system_broadcast': '📢 Broadcast',
                'system_tools': '⚡ System Tools',
                'project_verification': '✅ Project Verification',
                'points_system': '🏆 Points System',
                'system_archive': '📚 System Archive',
                'earth_features': '🌍 Earth Features',
                'member_management': 'Advanced Member Management',
                'select_member': 'Select Member',
                'select_member_option': '-- Select Member --',
                'change_username': 'Change Username',
                'new_username_placeholder': 'New Username',
                'change_rank': 'Change Rank',
                'ban_duration': 'Ban User (Days)',
                'ban_duration_placeholder': 'Ban duration in days (0 to unban)',
                'apply_changes': 'Apply Changes',
                'kick_user': 'Kick User',
                'ban_user': 'Ban User',
                'remove_user': 'Permanent Delete',
                'system_control': 'System Control',
                'clear_messages': 'Clear All Messages',
                'export_data': 'Export Data',
                'system_info': 'System Info',
                'view_all_chats': 'View All Dark Chats',
                'delete_all_users': 'Delete All Accounts',
                'system_stats': 'System Statistics',
                'special_system_tools': 'Special System Tools 🚀',
                'mass_promotion': 'Mass Promotion',
                'reset_system': 'Reset System',
                'fake_activity': 'Fake Activity',
                'emergency_lockdown': 'Emergency Lockdown',
                'hack_mode': 'Hack Mode',
                'earth_control': 'Earth Control',
                'dark_chats_log': '📋 Dark Chats Log',
                'close_button': 'Close',
                'verify_project': 'Verify New Project',
                'project_name': 'Project Name',
                'project_name_placeholder': 'Enter project name',
                'project_description': 'Project Description',
                'project_description_placeholder': 'Enter project description',
                'project_images': 'Project Images',
                'project_images_hint': 'You can upload multiple project images',
                'submit_project': 'Submit for Review',
                'my_projects': 'My Projects',
                'review_projects': 'Review Projects',
                'your_points': 'Your Points',
                'points_leaderboard': 'Points Leaderboard',
                'how_to_earn': 'How to Earn Points',
                'daily_login': 'Daily Login',
                'verified_project': 'Verified Project',
                'active_participation': 'Active Participation',
                'special_achievements': 'Special Achievements',
                'manage_points': 'Manage Points',
                'select_user': 'Select User',
                'select_user_option': '-- Select User --',
                'points_amount': 'Points Amount',
                'add_points': 'Add Points',
                'remove_points': 'Remove Points',
                'reset_points': 'Reset Points',
                'project_submitted': 'Project submitted successfully',
                'project_approved': 'Project verified',
                'project_rejected': 'Project rejected',
                'points_added': 'Points added',
                'points_removed': 'Points removed',
                'points_reset': 'Points reset',
                'load_archive': 'Load Archive'
            }
            // باقي اللغات...
        };

        // تهيئة التطبيق الموسعة
        document.addEventListener('DOMContentLoaded', function() {
            // إعداد النظام إذا لم يكن موجوداً
            if (users.length === 0) {
                const systemUser = {
                    id: "system_00",
                    username: "00",
                    password: "sys123sys",
                    rank: "system",
                    status: "online",
                    banned: false,
                    banUntil: null,
                    removed: false,
                    joinDate: new Date().toISOString()
                };

                users.push(systemUser);
                saveUsers();
                // ensure system has a color
                if (!userColors[systemUser.id]) {
                    userColors[systemUser.id] = assignColorToUser(systemUser.id);
                    localStorage.setItem('shadowRootUserColors', JSON.stringify(userColors));
                }
            }

            // إعداد النقاط للمستخدمين الموجودين
            // Use the "in" operator so that 0 is treated as a valid value (not falsy)
            users.forEach(user => {
                if (!(user.id in userPoints)) {
                    userPoints[user.id] = 0;
                }
            });
            saveUserPoints();

            // إعداد الأرشيف إذا لم يكن موجوداً
            if (systemArchive.length === 0) {
                systemArchive = [{
                    id: Date.now(),
                    type: 'system',
                    action: 'system_init',
                    description: 'تهيئة النظام لأول مرة',
                    timestamp: new Date().toISOString(),
                    user: 'system'
                }];
                saveArchive();
            }

            // إعداد اختيار اللغة
            const languageSelect = document.getElementById('languageSelect');
            languageSelect.addEventListener('change', function() {
                currentLanguage = this.value;
                updateLanguage();
            });

            // التحقق من وجود مستخدم مسجل
            const savedUser = localStorage.getItem('shadowRootCurrentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                
                // التحقق من انتهاء الحظر
                checkBanStatus();
                
                // منح نقاط الدخول اليومي
                awardDailyLoginPoints();
                
                showMainApp();
            }
            
            // إعداد الأحداث
            setupEventListeners();
        });

        // تحديث اللغة
        function updateLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.placeholder = translations[currentLanguage][key];
                }
            });

            // تحديث اتجاه النص
            if (currentLanguage === 'ar') {
                document.documentElement.dir = 'rtl';
            } else {
                document.documentElement.dir = 'ltr';
            }
        }

        // إعداد المستمعين للأحداث الموسعة
        function setupEventListeners() {
            // تبديل بين تسجيل الدخول وإنشاء حساب
            document.querySelectorAll('.login-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.login-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab + 'Content').classList.add('active');
                });
            });
            
            // تسجيل الدخول
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            // إنشاء حساب
            document.getElementById('registerBtn').addEventListener('click', handleRegister);
            document.getElementById('registerConfirmPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleRegister();
            });
            
            // تسجيل الخروج
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // إرسال رسالة
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
            
            // إرسال رسالة في الدردشة المظلمة
            document.getElementById('sendDarkMessageBtn').addEventListener('click', sendDarkMessage);
            document.getElementById('darkMessageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendDarkMessage();
            });

            // إرسال رسالة خاصة
            document.getElementById('sendPrivateMessageBtn').addEventListener('click', sendPrivateMessage);
            document.getElementById('privateMessageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendPrivateMessage();
            });
            
            // البث العام
            document.getElementById('broadcastBtn').addEventListener('click', sendSystemBroadcast);
            
            // التبديل بين التبويبات
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    // Only activate content if user has permission for special tabs
                    const tabContentId = this.dataset.tab + 'Tab';
                    // archive tab visibility check
                    if (this.dataset.tab === 'archive' && !hasPermission('view_archive')) {
                        alert('ليس لديك صلاحية لرؤية الأرشيف');
                        return;
                    }
                    const contentEl = document.getElementById(tabContentId);
                    if (contentEl) contentEl.classList.add('active');
                    
                    if (this.dataset.tab === 'private') {
                        loadPrivateUsers();
                    } else if (this.dataset.tab === 'verification') {
                        loadUserProjects();
                        loadVerifiedProjects();
                    } else if (this.dataset.tab === 'points') {
                        loadPointsData();
                    } else if (this.dataset.tab === 'archive') {
                        loadArchive();
                    }
                });
            });
            
            // الدردشة المظلمة
            document.getElementById('createRoomBtn').addEventListener('click', createDarkRoom);
            document.getElementById('joinRoomBtn').addEventListener('click', joinDarkRoom);
            document.getElementById('leaveRoomBtn').addEventListener('click', leaveDarkRoom);
            
            // إدارة الأعضاء
            document.getElementById('updateMemberBtn').addEventListener('click', updateMember);
            document.getElementById('kickUserBtn').addEventListener('click', kickUser);
            document.getElementById('banUserBtn').addEventListener('click', banUser);
            document.getElementById('removeUserBtn').addEventListener('click', removeUser);
            document.getElementById('deleteAllUsersBtn').addEventListener('click', deleteAllUsers);
            
            // الميزات السرية
            document.getElementById('secretBtn').addEventListener('click', toggleSecretFeatures);
            
            // التحكم بالنظام
            document.getElementById('clearAllBtn').addEventListener('click', clearAllMessages);
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('systemInfoBtn').addEventListener('click', showSystemInfo);
            document.getElementById('viewAllChatsBtn').addEventListener('click', viewAllDarkChats);
            
            // أحداث جديدة
            document.getElementById('submitProjectBtn').addEventListener('click', submitProject);
            document.getElementById('addPointsBtn').addEventListener('click', addPoints);
            document.getElementById('removePointsBtn').addEventListener('click', removePoints);
            document.getElementById('resetPointsBtn').addEventListener('click', resetPoints);

            // Export / Import backups
            const exportBtn = document.getElementById('exportBackupBtn');
            if (exportBtn) exportBtn.addEventListener('click', exportDataBackup);
            const importBtn = document.getElementById('importBackupBtn');
            const importInput = document.getElementById('importBackupInput');
            if (importBtn && importInput) {
                importBtn.addEventListener('click', function() {
                    importInput.click();
                });
                importInput.addEventListener('change', function(e) {
                    const f = e.target.files[0];
                    if (f) importDataBackup(f);
                });
            }
        }

        // توليد معرف فريد للمستخدم
        function generateUserId() {
            return Date.now().toString();
        }

        // التحقق من الصلاحيات الموسعة
        function hasPermission(permission) {
            if (currentUser.rank === 'system') return true;
            return rankPermissions[currentUser.rank]?.includes(permission) || false;
        }

        // التحقق من حالة الحظر
        function checkBanStatus() {
            if (currentUser && currentUser.banned && new Date(currentUser.banUntil) > new Date()) {
                const remainingTime = Math.ceil((new Date(currentUser.banUntil) - new Date()) / (1000 * 60 * 60 * 24));
                alert(`أنت محظور! متبقي ${remainingTime} أيام`);
                handleLogout();
                return false;
            }
            return true;
        }

        // معالجة تسجيل الدخول
        function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!username || !password) {
                alert('يرجى ملء جميع الحقول');
                return;
            }
            
            const user = users.find(u => u.username === username && !u.removed);
            
            if (!user) {
                alert('اسم المستخدم غير صحيح');
                return;
            }

            if (user.removed) {
                alert('تم حذف هذا الحساب. إذا كنت تعتقد أن هذا خطأ، يرجاء مراجعة رتبة SYSTEM.');
                return;
            }
            
            if (user.password !== password) {
                alert('كلمة المرور غير صحيحة');
                return;
            }
            
            // التحقق من الحظر
            if (user.banned && new Date(user.banUntil) > new Date()) {
                const remainingTime = Math.ceil((new Date(user.banUntil) - new Date()) / (1000 * 60 * 60 * 24));
                alert(`أنت محظور! متبقي ${remainingTime} أيام`);
                return;
            }
            
            user.banned = false;
            user.banUntil = null;
            user.status = "online";
            
            currentUser = user;
            localStorage.setItem('shadowRootCurrentUser', JSON.stringify(currentUser));
            saveUsers();
            
            // تسجيل الدخول في الأرشيف
            addToArchive('user_login', `تسجيل دخول المستخدم ${username}`);
            
            showMainApp();
        }

        // معالجة إنشاء حساب
        function handleRegister() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();
            
            if (!username || !password || !confirmPassword) {
                alert('يرجى ملء جميع الحقول');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('كلمات المرور غير متطابقة');
                return;
            }
            
            if (reservedUsernames.includes(username)) {
                alert('اسم المستخدم محجوز، يرجى اختيار اسم آخر');
                return;
            }
            
            if (users.find(u => u.username === username && !u.removed)) {
                alert('اسم المستخدم موجود مسبقاً');
                return;
            }
            
            const newUser = {
                id: generateUserId(),
                username: username,
                password: password,
                rank: "d",
                status: "online",
                banned: false,
                banUntil: null,
                removed: false,
                joinDate: new Date().toISOString()
            };
            
            users.push(newUser);
            saveUsers();

            // assign a color for the new user
            if (!userColors[newUser.id]) {
                userColors[newUser.id] = assignColorToUser(newUser.id);
                localStorage.setItem('shadowRootUserColors', JSON.stringify(userColors));
            }
            
            // إضافة نقاط بداية
            userPoints[newUser.id] = 0;
            saveUserPoints();
            
            // تسجيل إنشاء الحساب في الأرشيف
            addToArchive('user_register', `إنشاء حساب جديد للمستخدم ${username}`);
            
            alert('تم إنشاء الحساب بنجاح! يمكنك الآن تسجيل الدخول');
            
            // التبديل إلى تبويب تسجيل الدخول
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.login-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.login-tab[data-tab="login"]').classList.add('active');
            document.getElementById('loginContent').classList.add('active');
            
            // تفريغ الحقول
            document.getElementById('registerUsername').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerConfirmPassword').value = '';
        }

        // معالجة تسجيل الخروج
        function handleLogout() {
            if (currentUser) {
                // تسجيل الخروج في الأرشيف
                addToArchive('user_logout', `تسجيل خروج المستخدم ${currentUser.username}`);
                
                currentUser.status = "offline";
                saveUsers();
            }
            
            currentUser = null;
            localStorage.removeItem('shadowRootCurrentUser');
            
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            
            // تفريغ الحقول
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // عرض التطبيق الرئيسي مع الصلاحيات الجديدة
        function showMainApp() {
            if (!checkBanStatus()) return;
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            
            // تحديث معلومات المستخدم
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('userRank').textContent = getRankName(currentUser.rank);
            document.getElementById('userPoints').textContent = `النقاط: ${userPoints[currentUser.id] || 0}`;
            document.getElementById('userAvatar').textContent = currentUser.username.charAt(0).toUpperCase();
            document.getElementById('userAvatar').className = `user-avatar avatar-${currentUser.rank}`;
            document.getElementById('userStatus').innerHTML = `
                <span class="user-status status-${currentUser.status}"></span>
                ${currentUser.status === 'online' ? 'نشط' : 'غير نشط'}
            `;
            
            // إظهار الميزات الخاصة حسب الرتبة
            updatePermissionsUI();
            
            // تحميل البيانات
            loadMessages();
            loadMembers();
            updateMemberSelect();
            updateSystemStats();
            loadPointsData();
            updatePointsUserSelect();
            // initialize private users and unread badge
            loadPrivateUsers();
            updatePrivateTabBadge();
            
            // إظهار تبويبي التوثيق والنقاط للجميع
            const vTab = document.querySelector('.tab[data-tab="verification"]');
            const pTab = document.querySelector('.tab[data-tab="points"]');
            const aTab = document.querySelector('.tab[data-tab="archive"]');
            if (vTab) vTab.classList.add('visible');
            if (pTab) pTab.classList.add('visible');
            // تحديث عرض ميزات الرتبة داخل لوحة الإدارة
            renderRankFeatures();
        }

        // تحديث واجهة المستخدم حسب الصلاحيات الموسعة
        function updatePermissionsUI() {
            // إظهار/إخفاء تبويب الإدارة
            const adminTabBtn = document.querySelector('.tab[data-tab="admin"]');
            if (hasPermission('manage_users')) {
                if (adminTabBtn) adminTabBtn.classList.add('visible');
            } else {
                if (adminTabBtn) adminTabBtn.classList.remove('visible');
            }

            // إظهار/إخفاء تبويب المراسلة الخاصة
            const privateTabBtn = document.querySelector('.tab[data-tab="private"]');
            if (privateTabBtn) privateTabBtn.classList.add('visible');

            // إظهار/إخفاء زر الميزات السرية
            if (hasPermission('manage_users') || hasPermission('view_reports')) {
                document.getElementById('secretBtn').style.display = 'block';
                document.getElementById('secretFeatures').style.display = 'block';
            } else {
                document.getElementById('secretBtn').style.display = 'none';
                document.getElementById('secretFeatures').style.display = 'none';
            }

            // إظهار/إخفاء زر البث العام (للسستم فقط)
            if (currentUser.rank === 'system') {
                document.getElementById('broadcastBtn').style.display = 'block';
                document.getElementById('systemToolsCard').style.display = 'block';
                document.getElementById('reviewProjectsCard').style.display = 'block';
                document.getElementById('managePointsCard').style.display = 'block';
                document.getElementById('earthFeaturesItem').style.display = 'block';
            } else {
                document.getElementById('broadcastBtn').style.display = 'none';
                document.getElementById('systemToolsCard').style.display = 'none';
                document.getElementById('reviewProjectsCard').style.display = 'none';
                document.getElementById('managePointsCard').style.display = 'none';
                document.getElementById('earthFeaturesItem').style.display = 'none';
            }

            // إظهار/إخفاء الوصول للدردشات المظلمة
            if (!hasPermission('view_dark_chats')) {
                document.getElementById('darkChatsItem').style.display = 'none';
            }

            // إظهار/إخفاء ميزات الأرض
            if (!hasPermission('earth_control')) {
                document.getElementById('earthFeaturesItem').style.display = 'none';
            }

            // تحديث عرض ميزات الرتبة داخل لوحة الإدارة
            renderRankFeatures();
        }

        // عرض ميزات الرتبة داخل لوحة الإدارة
        function renderRankFeatures() {
            const container = document.getElementById('rankFeaturesList');
            if (!container) return;

            let features = [];
            if (!currentUser) {
                container.innerHTML = '<em>سجل الدخول لرؤية ميزات الرتبة</em>';
                return;
            }

            if (currentUser.rank === 'system') {
                // system can do everything
                features = ['كل الصلاحيات: ترقية، حظر، حذف، إدارة النقاط، الوصول للأرشيف، أدوات النظام الخاصة'];
            } else {
                const permList = rankPermissions[currentUser.rank] || [];
                if (permList.length === 0) {
                    features = ['لا توجد ميزات خاصة لهذه الرتبة'];
                } else {
                    features = permList.slice();
                }
            }

            container.innerHTML = '';
            const ul = document.createElement('ul');
            ul.style.margin = '0';
            ul.style.paddingLeft = '18px';
            features.forEach(f => {
                const li = document.createElement('li');
                li.textContent = f;
                ul.appendChild(li);
            });
            container.appendChild(ul);
        }

        // تحديث شارة التنبيه لتبويب المراسلة الخاصة
        function updatePrivateTabBadge() {
            const total = Object.keys(privateUnread).reduce((sum, fromId) => {
                const inner = privateUnread[fromId] || {};
                return sum + Object.values(inner).reduce((s, v) => s + (Number(v) || 0), 0);
            }, 0);
            const privateTab = document.querySelector('.tab[data-tab="private"]');
            if (!privateTab) return;
            let badge = privateTab.querySelector('.tab-unread');
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'tab-unread';
                badge.style.background = 'var(--accent)';
                badge.style.color = '#000';
                badge.style.padding = '2px 6px';
                badge.style.borderRadius = '12px';
                badge.style.marginLeft = '8px';
                badge.style.fontSize = '12px';
                privateTab.appendChild(badge);
            }
            badge.textContent = total > 0 ? total : '';
        }

        // إرسال رسالة مع تنسيق خاص للرتب والنقاط
        function sendMessage() {
            if (!checkBanStatus()) return;
            
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText) return;
            
            const message = {
                id: Date.now(),
                userId: currentUser.id,
                userName: currentUser.username,
                userRank: currentUser.rank,
                userPoints: userPoints[currentUser.id] || 0,
                text: messageText,
                timestamp: new Date().toISOString(),
                banned: false
            };
            
            messages.push(message);
            saveMessages();
            
            // إضافة نقاط للمشاركة
            addUserPoints(currentUser.id, 1);
            
            loadMessages();
            
            messageInput.value = '';
            
            // تسجيل الرسالة في الأرشيف
            addToArchive('chat_message', `رسالة من ${currentUser.username}: ${messageText.substring(0, 50)}...`);
        }

        // تحميل الرسائل مع التنسيق الخاص الموسع
        function loadMessages() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.banned ? 'banned' : ''} ${msg.userRank} ${msg.isBroadcast ? 'broadcast-message' : ''} message-with-points`;
                
                const messageHeader = document.createElement('div');
                messageHeader.className = 'message-header';
                
                const senderSpan = document.createElement('span');
                senderSpan.className = `message-sender sender-${msg.userRank}`;
                
                // إضافة شارة خاصة للرتب مع النقاط
                let rankBadge = '';
                if (msg.userRank === 'system') {
                    rankBadge = `👑 <span style="color: gold;">SYSTEM</span>`;
                } else if (msg.userRank === 's') {
                    rankBadge = `⚡ <span style="color: var(--rank-s);">S</span>`;
                } else if (msg.userRank === 'a') {
                    rankBadge = `🔧 <span style="color: var(--rank-a);">A</span>`;
                } else if (msg.userRank === 'b') {
                    rankBadge = `💻 <span style="color: var(--rank-b);">B</span>`;
                } else if (msg.userRank === 'c') {
                    rankBadge = `👨‍💻 <span style="color: var(--rank-c);">C</span>`;
                } else {
                    rankBadge = `🎓 <span style="color: var(--rank-d);">D</span>`;
                }
                
                if (msg.isBroadcast) {
                    senderSpan.innerHTML = `<div class="broadcast-header">📢 ${rankBadge}: ${msg.userName}</div>`;
                } else {
                    senderSpan.innerHTML = `${rankBadge} ${msg.userName} <span style="color: var(--hacker-green); font-size: 10px;">(${msg.userPoints || 0} نقطة)</span>`;
                }
                
                const timeSpan = document.createElement('span');
                timeSpan.textContent = new Date(msg.timestamp).toLocaleTimeString();
                
                messageHeader.appendChild(senderSpan);
                messageHeader.appendChild(timeSpan);
                
                const messageText = document.createElement('div');
                // إصلاح مشكلة ظهور HTML في نص الرسالة
                if (msg.isBroadcast) {
                    messageText.innerHTML = msg.text;
                } else {
                    messageText.textContent = msg.banned ? '[رسالة محذوفة]' : msg.text;
                }
                
                const messageActions = document.createElement('div');
                messageActions.className = 'message-actions';
                
                // يمكن للمستخدم حذف رسائله فقط، المدير والنظام يمكنهم حذف أي رسالة
                if (currentUser.id === msg.userId || hasPermission('delete_messages')) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = 'حذف';
                    deleteBtn.onclick = function() {
                        deleteMessage(msg.id);
                    };
                    messageActions.appendChild(deleteBtn);
                    
                    // المدير والنظام فقط يمكنهم حظر الرسائل
                    if (hasPermission('ban_users') && !msg.banned) {
                        const banBtn = document.createElement('button');
                        banBtn.className = 'ban-btn';
                        banBtn.textContent = 'حظر';
                        banBtn.onclick = function() {
                            banMessage(msg.id);
                        };
                        messageActions.appendChild(banBtn);
                    }
                }
                
                messageDiv.appendChild(messageHeader);
                messageDiv.appendChild(messageText);
                messageDiv.appendChild(messageActions);
                
                // إضافة مؤشر النقاط للرسائل ذات النقاط العالية
                if (msg.userPoints >= 50 && !msg.isBroadcast) {
                    const pointsIndicator = document.createElement('div');
                    pointsIndicator.className = 'points-indicator';
                    pointsIndicator.textContent = '★';
                    messageDiv.appendChild(pointsIndicator);
                }
                
                chatMessages.appendChild(messageDiv);
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // إرسال بث عام (للسستم فقط)
        function sendSystemBroadcast() {
            if (currentUser.rank !== 'system') {
                alert('ليس لديك صلاحية للبث العام');
                return;
            }
            
            const broadcastMessage = prompt('أدخل رسالة البث العام:');
            if (!broadcastMessage) return;
            
            const message = {
                id: Date.now(),
                userId: "system",
                userName: "00",
                userRank: "system",
                userPoints: 9999,
                text: `📢 <span style="color: gold; text-shadow: 0 0 10px gold;">SYSTEM BROADCAST:</span> ${broadcastMessage}`,
                timestamp: new Date().toISOString(),
                banned: false,
                isBroadcast: true
            };
            
            messages.push(message);
            saveMessages();
            loadMessages();
            
            // تسجيل البث في الأرشيف
            addToArchive('system_broadcast', `بث نظامي: ${broadcastMessage}`);
            
            alert('تم إرسال البث العام بنجاح');
        }

        // تحميل المستخدمين للمراسلة الخاصة
        function loadPrivateUsers() {
            const privateUsersList = document.getElementById('privateUsersList');
            privateUsersList.innerHTML = '';
            
            users.forEach(user => {
                if (user.id !== currentUser.id && !user.removed) {
                    const userItem = document.createElement('div');
                    userItem.className = 'private-user-item';
                    userItem.dataset.userId = user.id;

                    // unread messages from this user to currentUser
                    const convUnread = (privateUnread[user.id] && privateUnread[user.id][currentUser.id]) ? privateUnread[user.id][currentUser.id] : 0;
                    const unreadBadgeHTML = convUnread > 0 ? `<span class="unread-badge">${convUnread}</span>` : '';

                    userItem.innerHTML = `
                        <div style="font-weight: bold;">${user.username} ${unreadBadgeHTML}</div>
                        <div style="font-size: 12px; color: #aaa;">${getRankName(user.rank)} | ${userPoints[user.id] || 0} نقطة</div>
                    `;
                    
                    userItem.addEventListener('click', function() {
                        document.querySelectorAll('.private-user-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        this.classList.add('active');
                        selectedPrivateUser = user.id;
                        // mark conversation as read for messages from this user to currentUser
                        if (privateUnread[user.id]) {
                            privateUnread[user.id][currentUser.id] = 0;
                            savePrivateUnread();
                        }
                        updatePrivateTabBadge();
                        loadPrivateMessagesWithUser(user.id);
                    });
                    
                    privateUsersList.appendChild(userItem);
                }
            });
        }

        // تحميل الرسائل الخاصة مع مستخدم معين
        function loadPrivateMessagesWithUser(userId) {
            const privateMessagesContainer = document.getElementById('privateMessages');
            privateMessagesContainer.innerHTML = '';
            
            const userPrivateMessages = privateMessages.filter(msg => 
                (msg.senderId === currentUser.id && msg.recipientId === userId) ||
                (msg.senderId === userId && msg.recipientId === currentUser.id)
            );
            
            userPrivateMessages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            userPrivateMessages.forEach(msg => {
                // Skip message if current user marked it deleted
                if (msg.deletedBy && msg.deletedBy[currentUser.id]) return;

                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';

                const isSent = msg.senderId === currentUser.id;
                const senderName = msg.senderName || users.find(u => u.id === msg.senderId)?.username || 'مستخدم';
                const recipientName = msg.recipientName || users.find(u => u.id === msg.recipientId)?.username || 'مستخدم';

                messageDiv.style.borderLeftColor = isSent ? 'var(--success)' : 'var(--warning)';
                messageDiv.style.background = isSent ?
                    'linear-gradient(45deg, rgba(0, 184, 148, 0.2), rgba(0, 0, 0, 0.3))' :
                    'linear-gradient(45deg, rgba(253, 203, 110, 0.2), rgba(0, 0, 0, 0.3))';

                const messageHeader = document.createElement('div');
                messageHeader.className = 'message-header';

                const senderSpan = document.createElement('span');
                senderSpan.className = 'message-sender';
                const senderColor = getUserMessageColor(msg.senderId);
                senderSpan.innerHTML = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${senderColor};margin-inline-start:6px;vertical-align:middle;"></span> ${senderName} → ${recipientName}`;
                senderSpan.style.color = '#fff';
                senderSpan.style.background = 'rgba(0,0,0,0.15)';
                senderSpan.style.padding = '4px 8px';
                senderSpan.style.borderRadius = '6px';
                senderSpan.style.borderLeft = `6px solid ${senderColor}`;

                const timeSpan = document.createElement('span');
                timeSpan.textContent = new Date(msg.timestamp).toLocaleTimeString();

                messageHeader.appendChild(senderSpan);
                messageHeader.appendChild(timeSpan);

                const messageText = document.createElement('div');
                messageText.textContent = msg.text;

                const messageActions = document.createElement('div');
                messageActions.className = 'message-actions';

                // Allow sender or recipient to mark message deleted for themselves
                if (currentUser.id === msg.senderId || currentUser.id === msg.recipientId) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = 'حذف';
                    deleteBtn.onclick = function() { deletePrivateMessage(msg.id); };
                    messageActions.appendChild(deleteBtn);
                }

                messageDiv.appendChild(messageHeader);
                messageDiv.appendChild(messageText);
                messageDiv.appendChild(messageActions);

                privateMessagesContainer.appendChild(messageDiv);
            });
            
            privateMessagesContainer.scrollTop = privateMessagesContainer.scrollHeight;
            // mark conversation read (clear unread count)
            if (privateUnread[userId] && privateUnread[userId][currentUser.id]) {
                privateUnread[userId][currentUser.id] = 0;
                savePrivateUnread();
                updatePrivateTabBadge();
            }
        }

        // إرسال رسالة خاصة
        function sendPrivateMessage() {
            if (!selectedPrivateUser) {
                alert('يرجى اختيار مستلم أولاً');
                return;
            }
            
            const messageInput = document.getElementById('privateMessageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText) {
                alert('يرجى كتابة رسالة');
                return;
            }
            
            const privateMessage = {
                id: Date.now(),
                senderId: currentUser.id,
                senderName: currentUser.username,
                recipientName: users.find(u => u.id === selectedPrivateUser)?.username || 'مستخدم',
                recipientId: selectedPrivateUser,
                text: messageText,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            privateMessages.push(privateMessage);
            savePrivateMessages();
            // increment unread counter for recipient (senderId -> recipientId)
            if (!privateUnread[currentUser.id]) privateUnread[currentUser.id] = {};
            if (!privateUnread[currentUser.id][selectedPrivateUser]) privateUnread[currentUser.id][selectedPrivateUser] = 0;
            privateUnread[currentUser.id][selectedPrivateUser] += 1;
            savePrivateUnread();
            updatePrivateTabBadge();
            loadPrivateMessagesWithUser(selectedPrivateUser);
            
            // تسجيل الرسالة الخاصة في الأرشيف
            addToArchive('private_message', `رسالة خاصة من ${currentUser.username} إلى ${users.find(u => u.id === selectedPrivateUser)?.username}`);
            
            messageInput.value = '';
        }

        // حذف رسالة خاصة للمتعلق الحالي - علامة حذف لكل مستخدم على حدة
        function deletePrivateMessage(messageId) {
            const msg = privateMessages.find(m => m.id === messageId);
            if (!msg) return;

            // initialize deletedBy map if absent
            if (!msg.deletedBy) msg.deletedBy = {};
            msg.deletedBy[currentUser.id] = true;

            // if both sender and recipient marked deleted, remove message permanently
            const senderDeleted = !!msg.deletedBy[msg.senderId];
            const recipientDeleted = !!msg.deletedBy[msg.recipientId];

            if (senderDeleted && recipientDeleted) {
                const idx = privateMessages.findIndex(m => m.id === messageId);
                if (idx !== -1) privateMessages.splice(idx, 1);
            }

            savePrivateMessages();
            // also, if current user was recipient and there was an unread count from sender, decrement/clear
            if (msg.senderId && privateUnread[msg.senderId] && privateUnread[msg.senderId][currentUser.id]) {
                privateUnread[msg.senderId][currentUser.id] = Math.max(0, privateUnread[msg.senderId][currentUser.id] - 1);
                savePrivateUnread();
                updatePrivateTabBadge();
            }

            loadPrivateMessagesWithUser(selectedPrivateUser);
        }

        // أدوات النظام الخاصة الموسعة
        function massPromotion() {
            if (currentUser.rank !== 'system') return;
            
            if (confirm('هل تريد ترقية جميع الأعضاء إلى رتبة A؟')) {
                users.forEach(user => {
                    if (user.rank === 'd' || user.rank === 'c' || user.rank === 'b') {
                        user.rank = 'a';
                    }
                });
                saveUsers();
                loadMembers();
                
                // تسجيل الترقية في الأرشيف
                addToArchive('mass_promotion', 'ترقية جماعية لجميع الأعضاء إلى رتبة A');
                
                alert('تمت الترقية الجماعية بنجاح!');
            }
        }

        function resetSystem() {
            if (currentUser.rank !== 'system') return;
            
            if (confirm('⚠️ تحذير: هذا الإجراء سيمسح جميع البيانات! هل أنت متأكد؟')) {
                if (confirm('❌ تأكيد نهائي: جميع البيانات سيتم حذفها ولا يمكن استرجاعها!')) {
                    // تسجيل إعادة التعيين في الأرشيف
                    addToArchive('system_reset', 'إعادة تعيين النظام بالكامل');
                    
                    localStorage.clear();
                    location.reload();
                }
            }
        }

        function createFakeActivity() {
            if (currentUser.rank !== 'system') return;
            
            const fakeMessages = [
                "مرحباً بالجميع في النظام! 👋",
                "نظام Shadow Root يعمل بشكل ممتاز 🚀",
                "شكراً لكم على المشاركة الفعالة 💪",
                "نرحب بالأعضاء الجدد في فريقنا 🌟",
                "النظام آمن ومحمي بالكامل 🔒"
            ];
            
            fakeMessages.forEach((text, index) => {
                setTimeout(() => {
                    const message = {
                        id: Date.now() + index,
                        userId: "system_fake",
                        userName: "نظام",
                        userRank: "system",
                        text: text,
                        timestamp: new Date().toISOString(),
                        banned: false
                    };
                    messages.push(message);
                    saveMessages();
                    if (index === fakeMessages.length - 1) {
                        loadMessages();
                        
                        // تسجيل النشاط الوهمي في الأرشيف
                        addToArchive('fake_activity', 'إنشاء نشاط وهمي في النظام');
                        
                        alert('تم إنشاء النشاط الوهمي بنجاح!');
                    }
                }, index * 1000);
            });
        }

        function emergencyLockdown() {
            if (currentUser.rank !== 'system') return;
            
            if (confirm('🚨 تفعيل وضع الطوارئ: سيتم غلق جميع الغرف وحظر الدردشة العامة!')) {
                // غلق جميع الغرف
                darkChatRooms.forEach(room => {
                    room.active = false;
                });
                
                // إضافة رسالة نظام
                const systemMessage = {
                    id: Date.now(),
                    userId: "system",
                    userName: "00",
                    userRank: "system",
                    text: "🚨 <span style='color: red; text-shadow: 0 0 10px red;'>SYSTEM LOCKDOWN:</span> تم تفعيل وضع الطوارئ! جميع الغرف مغلقة مؤقتاً.",
                    timestamp: new Date().toISOString(),
                    banned: false,
                    isBroadcast: true
                };
                
                messages.push(systemMessage);
                saveMessages();
                saveDarkRooms();
                loadMessages();
                
                // تسجيل وضع الطوارئ في الأرشيف
                addToArchive('emergency_lockdown', 'تفعيل وضع الطوارئ في النظام');
                
                alert('تم تفعيل وضع الطوارئ بنجاح!');
            }
        }

        function hackMode() {
            if (currentUser.rank !== 'system') return;
            
            document.body.style.animation = 'glitch 0.5s infinite';
            setTimeout(() => {
                document.body.style.animation = '';
                
                // تسجيل وضع الهاكر في الأرشيف
                addToArchive('hack_mode', 'تفعيل وضع الهاكر في النظام');
                
                alert('⚡ تم تفعيل وضع الهاكر! النظام في أعلى درجات الأمان');
            }, 2000);
        }

        function earthControl() {
            if (currentUser.rank !== 'system') return;
            
            const earthFeatures = `
                🌍 أدوات تحكم الأرض المتقدمة:
                
                1. 🔍 مراقبة جميع الدردشات المغلقة
                2. 📊 إحصائيات النظام العالمية
                3. 🛡️ حماية متقدمة للنظام
                4. 🔄 السيطرة الكاملة على الصلاحيات
                5. 📜 سجلات النظام الكاملة
                
                هذه الأدوات تمنحك تحكم كامل في نظام Shadow Root!
            `;
            
            alert(earthFeatures);
            
            // تسجيل استخدام أدوات الأرض في الأرشيف
            addToArchive('earth_control', 'استخدام أدوات تحكم الأرض المتقدمة');
        }

        // حذف جميع الحسابات (باستثناء النظام)
        function deleteAllUsers() {
            if (currentUser.rank !== 'system') {
                alert('ليس لديك صلاحية لحذف جميع الحسابات');
                return;
            }
            
            if (confirm('⚠️ تحذير: هذا الإجراء سيحذف جميع الحسابات باستثناء النظام!')) {
                users = users.filter(user => user.rank === 'system');
                saveUsers();
                loadMembers();
                updateMemberSelect();
                
                // تسجيل حذف الحسابات في الأرشيف
                addToArchive('delete_all_users', 'حذف جميع حسابات المستخدمين');
                
                alert('تم حذف جميع الحسابات بنجاح!');
            }
        }

        // وظائف مساعدة محدثة
        function getRankName(rank) {
            const rankNames = {
                'system': '👑 SYSTEM',
                's': '⚡ S',
                'a': '🔧 A',
                'b': '💻 B',
                'c': '👨‍💻 C',
                'd': '🎓 D'
            };
            
            return rankNames[rank] || 'غير معروف';
        }
        
        function getRankColor(rank) {
            const rankColors = {
                'system': 'var(--rank-system)',
                's': 'var(--rank-s)',
                'a': 'var(--rank-a)',
                'b': 'var(--rank-b)',
                'c': 'var(--rank-c)',
                'd': 'var(--rank-d)'
            };
            
            return rankColors[rank] || 'var(--light)';
        }

        // Message color helpers
        const colorPalette = ['#00b894','#0984e3','#6c5ce7','#e84393','#fdcb6e','#e17055','#00cec9','#ffeaa7','#fab1a0'];

        function assignColorToUser(userId) {
            // pick a color deterministically if possible
            const idx = Math.abs(hashCode(userId)) % colorPalette.length;
            return colorPalette[idx];
        }

        function hashCode(str) {
            let h = 0;
            for (let i = 0; i < str.length; i++) {
                h = (h << 5) - h + str.charCodeAt(i);
                h |= 0; // convert to 32bit int
            }
            return h;
        }

        function getUserMessageColor(userId) {
            if (!userColors[userId]) {
                userColors[userId] = assignColorToUser(userId);
                localStorage.setItem('shadowRootUserColors', JSON.stringify(userColors));
            }
            return userColors[userId];
        }

        // حفظ البيانات في localStorage
        function saveUsers() {
            localStorage.setItem('shadowRootUsers', JSON.stringify(users));
        }
        
        function saveMessages() {
            localStorage.setItem('shadowRootMessages', JSON.stringify(messages));
        }
        
        function savePrivateMessages() {
            localStorage.setItem('shadowRootPrivateMessages', JSON.stringify(privateMessages));
        }

        function savePrivateUnread() {
            localStorage.setItem('shadowRootPrivateUnread', JSON.stringify(privateUnread));
        }
        
        function saveDarkRooms() {
            localStorage.setItem('shadowRootDarkRooms', JSON.stringify(darkChatRooms));
        }
        
        function saveProjects() {
            localStorage.setItem('shadowRootProjects', JSON.stringify(projects));
        }
        
        function saveUserPoints() {
            localStorage.setItem('shadowRootUserPoints', JSON.stringify(userPoints));
        }
        
        function saveDailyLogin() {
            localStorage.setItem('shadowRootDailyLogin', JSON.stringify(dailyLogin));
        }
        
        function saveArchive() {
            localStorage.setItem('shadowRootArchive', JSON.stringify(systemArchive));
        }

        // إضافة إلى الأرشيف
        function addToArchive(type, description) {
            const archiveItem = {
                id: Date.now(),
                type: type,
                action: type,
                description: description,
                timestamp: new Date().toISOString(),
                user: currentUser ? currentUser.username : 'system'
            };
            
            systemArchive.push(archiveItem);
            saveArchive();
        }

        // Pending promotions helpers
        function savePendingPromotions() {
            localStorage.setItem('shadowRootPendingPromotions', JSON.stringify(pendingPromotions));
        }

        function requestPromotion(userId, targetRank) {
            // Create a pending promotion that requires SYSTEM approval
            const user = users.find(u => u.id === userId);
            if (!user) return alert('المستخدم غير موجود');

            // if already pending, ignore
            if (pendingPromotions.find(p => p.userId === userId && p.targetRank === targetRank && p.status === 'pending')) {
                return alert('هناك طلب ترقية معلق بالفعل لهذا المستخدم');
            }

            const req = {
                id: Date.now(),
                userId: userId,
                username: user.username,
                currentRank: user.rank,
                targetRank: targetRank,
                requestedAt: new Date().toISOString(),
                status: 'pending',
                handledBy: null,
                handledAt: null
            };

            pendingPromotions.push(req);
            savePendingPromotions();
            renderPendingPromotions();
            addToArchive('request_promotion', `طلب ترقية للمستخدم ${user.username} إلى رتبة ${targetRank}`);
            alert('تم إرسال طلب الترقية، ينتظر موافقة SYSTEM');
        }

        function renderPendingPromotions() {
            const list = document.getElementById('pendingPromotionsList');
            if (!list) return;
            list.innerHTML = '';

            if (pendingPromotions.length === 0) {
                list.innerHTML = '<p style="color:#aaa">لا توجد طلبات معلقة</p>';
                return;
            }

            pendingPromotions.slice().reverse().forEach(req => {
                const row = document.createElement('div');
                row.className = 'pending-promo';
                row.style.padding = '8px';
                row.style.borderBottom = '1px solid rgba(255,255,255,0.04)';
                row.innerHTML = `<div><strong>${req.username}</strong> طلب الترقية من ${req.currentRank} إلى ${req.targetRank} — ${new Date(req.requestedAt).toLocaleString()}</div>`;

                if (req.status === 'pending' && currentUser && currentUser.rank === 'system') {
                    const actions = document.createElement('div');
                    actions.style.marginTop = '6px';
                    const approve = document.createElement('button');
                    approve.className = 'btn btn-success';
                    approve.textContent = 'موافقة SYSTEM';
                    approve.onclick = function() { approvePromotion(req.id); };
                    const reject = document.createElement('button');
                    reject.className = 'btn btn-danger';
                    reject.style.marginLeft = '8px';
                    reject.textContent = 'رفض';
                    reject.onclick = function() { rejectPromotion(req.id); };
                    actions.appendChild(approve);
                    actions.appendChild(reject);
                    row.appendChild(actions);
                } else {
                    const status = document.createElement('div');
                    status.style.marginTop = '6px';
                    status.style.color = '#aaa';
                    status.textContent = `الحالة: ${req.status}`;
                    row.appendChild(status);
                }

                list.appendChild(row);
            });
        }

        function approvePromotion(requestId) {
            if (!currentUser || currentUser.rank !== 'system') return alert('فقط SYSTEM يمكنه الموافقة على الترقيات');
            const req = pendingPromotions.find(p => p.id === requestId);
            if (!req) return alert('طلب غير موجود');

            const user = users.find(u => u.id === req.userId);
            if (!user) return alert('المستخدم غير موجود');

            user.rank = req.targetRank;
            req.status = 'approved';
            req.handledBy = currentUser.username;
            req.handledAt = new Date().toISOString();

            saveUsers();
            savePendingPromotions();
            renderPendingPromotions();
            loadMembers();
            addToArchive('approve_promotion', `تمت ترقية ${user.username} إلى ${req.targetRank} بواسطة ${currentUser.username}`);
            alert('تمت الموافقة على الترقية');
        }

        function rejectPromotion(requestId) {
            if (!currentUser || currentUser.rank !== 'system') return alert('فقط SYSTEM يمكنه رفض الترقيات');
            const req = pendingPromotions.find(p => p.id === requestId);
            if (!req) return alert('طلب غير موجود');

            req.status = 'rejected';
            req.handledBy = currentUser.username;
            req.handledAt = new Date().toISOString();
            savePendingPromotions();
            renderPendingPromotions();
            addToArchive('reject_promotion', `رفض ترقية ${req.username} إلى ${req.targetRank} بواسطة ${currentUser.username}`);
            alert('تم رفض طلب الترقية');
        }

        // تحميل الأرشيف
        function loadArchive() {
            const archiveContent = document.getElementById('archiveContent');
            archiveContent.innerHTML = '';
            
            const archiveType = document.getElementById('archiveType').value;
            const archiveDate = document.getElementById('archiveDate').value;
            
            let filteredArchive = systemArchive;
            
            if (archiveType !== 'all') {
                filteredArchive = filteredArchive.filter(item => item.type === archiveType);
            }
            
            if (archiveDate) {
                filteredArchive = filteredArchive.filter(item => 
                    item.timestamp.startsWith(archiveDate)
                );
            }
            
            if (filteredArchive.length === 0) {
                archiveContent.innerHTML = '<p style="text-align: center; color: #666;">لا توجد سجلات</p>';
                return;
            }
            
            filteredArchive.reverse().forEach(item => {
                const archiveItem = document.createElement('div');
                archiveItem.className = 'archive-item';
                
                const itemHeader = document.createElement('div');
                itemHeader.className = 'archive-item-header';
                
                const itemInfo = document.createElement('div');
                itemInfo.innerHTML = `
                    <strong>${item.description}</strong>
                    <div style="font-size: 12px; color: #aaa;">
                        ${new Date(item.timestamp).toLocaleString()} | ${item.user}
                    </div>
                `;
                
                itemHeader.appendChild(itemInfo);
                archiveItem.appendChild(itemHeader);
                
                archiveContent.appendChild(archiveItem);
            });
        }

        // وظائف إضافية تحتاج إلى إكمال
        function deleteMessage(messageId) {
            const messageIndex = messages.findIndex(msg => msg.id === messageId);
            if (messageIndex !== -1) {
                messages.splice(messageIndex, 1);
                saveMessages();
                loadMessages();
                
                // تسجيل حذف الرسالة في الأرشيف
                addToArchive('delete_message', 'حذف رسالة من الدردشة العامة');
            }
        }

        function banMessage(messageId) {
            const message = messages.find(msg => msg.id === messageId);
            if (message) {
                message.banned = true;
                saveMessages();
                loadMessages();
                
                // تسجيل حظر الرسالة في الأرشيف
                addToArchive('ban_message', `حظر رسالة من ${message.userName}`);
            }
        }

        function loadMembers() {
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';
            
            users.forEach(user => {
                if (!user.removed) {
                    const userCard = document.createElement('div');
                    userCard.className = `user-card ${user.banned ? 'banned' : ''}`;
                    userCard.style.borderLeft = `4px solid ${getRankColor(user.rank)}`;
                    
                    const userHeader = document.createElement('div');
                    userHeader.className = 'user-card-header';
                    
                    const userInfo = document.createElement('div');
                    userInfo.innerHTML = `
                        <strong>${user.username}</strong> - ${getRankName(user.rank)}
                        <div style="font-size: 12px; color: #aaa;">
                            ${user.status === 'online' ? '🟢 متصل' : '🔴 غير متصل'}
                            ${user.banned ? ' | 🔴 محظور' : ''}
                            <br>النقاط: ${userPoints[user.id] || 0}
                        </div>
                    `;
                    
                    userHeader.appendChild(userInfo);
                    
                    if (hasPermission('manage_users') && user.id !== currentUser.id) {
                        const userActions = document.createElement('div');
                        userActions.className = 'user-actions';
                        
                        const banBtn = document.createElement('button');
                        banBtn.className = 'btn btn-warning';
                        banBtn.textContent = user.banned ? 'فك الحظر' : 'حظر';
                        banBtn.onclick = function() {
                            toggleBanUser(user.id);
                        };
                        
                        const kickBtn = document.createElement('button');
                        kickBtn.className = 'btn btn-danger';
                        kickBtn.textContent = 'طرد';
                        kickBtn.onclick = function() {
                            kickUser(user.id);
                        };
                        
                        userActions.appendChild(banBtn);
                        userActions.appendChild(kickBtn);
                        userHeader.appendChild(userActions);
                    }
                    
                    userCard.appendChild(userHeader);
                    
                    if (user.banned && user.banUntil) {
                        const banDuration = document.createElement('div');
                        banDuration.className = 'ban-duration';
                        banDuration.textContent = `ينتهي الحظر في: ${new Date(user.banUntil).toLocaleDateString()}`;
                        userCard.appendChild(banDuration);
                    }
                    
                    membersList.appendChild(userCard);
                }
            });
        }

        function updateMemberSelect() {
            const memberSelect = document.getElementById('memberSelect');
            memberSelect.innerHTML = '<option value="">-- اختر عضوا --</option>';
            
            users.forEach(user => {
                if (!user.removed && user.id !== currentUser.id) {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.username} (${getRankName(user.rank)}) - ${userPoints[user.id] || 0} نقطة`;
                    memberSelect.appendChild(option);
                }
            });
        }

        function updateSystemStats() {
            const systemStats = document.getElementById('systemStats');
            const activeUsers = users.filter(u => !u.removed && u.status === 'online').length;
            const totalUsers = users.filter(u => !u.removed).length;
            const totalMessages = messages.length;
            const bannedUsers = users.filter(u => u.banned && !u.removed).length;
            const totalPrivateMessages = privateMessages.length;
            const totalProjects = projects.length;
            const verifiedProjects = projects.filter(p => p.verified).length;
            
            systemStats.innerHTML = `
                <div class="terminal-line"><span class="terminal-prompt">$</span> المستخدمون النشطون: ${activeUsers}</div>
                <div class="terminal-line"><span class="terminal-prompt">$</span> إجمالي المستخدمين: ${totalUsers}</div>
                <div class="terminal-line"><span class="terminal-prompt">$</span> إجمالي الرسائل: ${totalMessages}</div>
                <div class="terminal-line"><span class="terminal-prompt">$</span> الرسائل الخاصة: ${totalPrivateMessages}</div>
                <div class="terminal-line"><span class="terminal-prompt">$</span> المشاريع: ${totalProjects} (${verifiedProjects} موثق)</div>
                <div class="terminal-line"><span class="terminal-prompt">$</span> المستخدمون المحظورون: ${bannedUsers}</div>
                <div class="terminal-line"><span class="terminal-prompt">$</span> الدردشات المظلمة: ${darkChatRooms.length}</div>
                <div class="terminal-line"><span class="terminal-prompt">$</span> سجلات الأرشيف: ${systemArchive.length}</div>
            `;
        }

        function toggleBanUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                if (user.banned) {
                    user.banned = false;
                    user.banUntil = null;
                    
                    // تسجيل فك الحظر في الأرشيف
                    addToArchive('unban_user', `فك حظر المستخدم ${user.username}`);
                } else {
                    const days = prompt('أدخل عدد أيام الحظر:');
                    if (days && !isNaN(days)) {
                        user.banned = true;
                        user.banUntil = new Date(Date.now() + parseInt(days) * 24 * 60 * 60 * 1000).toISOString();
                        
                        // تسجيل الحظر في الأرشيف
                        addToArchive('ban_user', `حظر المستخدم ${user.username} لمدة ${days} أيام`);
                    }
                }
                saveUsers();
                loadMembers();
            }
        }

        function kickUser(userId) {
            if (confirm('هل تريد حذف هذا المستخدم نهائياً من النظام؟ (هذا الإجراء لا يمكن التراجع عنه)')) {
                const user = users.find(u => u.id === userId);
                if (user) {
                    user.removed = true;
                    user.status = 'offline';
                    saveUsers();
                    loadMembers();
                    updateMemberSelect();

                    // تسجيل الحذف في الأرشيف
                    addToArchive('kick_user', `حذف المستخدم ${user.username} نهائياً`);

                    alert('تم حذف المستخدم نهائياً');
                }
            }
        }

        function updateMember() {
            const memberId = document.getElementById('memberSelect').value;
            const newName = document.getElementById('newName').value.trim();
            const newRank = document.getElementById('rankSelect').value;
            const banDuration = parseInt(document.getElementById('banDuration').value) || 0;
            
            if (!memberId) {
                alert('يرجى اختيار عضو');
                return;
            }
            
            const user = users.find(u => u.id === memberId);
            if (!user) return;
            
            // التحقق من الصلاحيات للترقية
            if (newRank && (newRank === 'system' || newRank === 's')) {
                if (currentUser.rank !== 'system') {
                    alert('لا يمكنك تعيين هذه الرتبة. فقط النظام يمكنه تعيين رتبة النظام وS');
                    return;
                }
            }
            
            if (newName) {
                user.username = newName;
            }
            
            if (newRank) {
                user.rank = newRank;
            }
            
            if (banDuration > 0) {
                user.banned = true;
                user.banUntil = new Date(Date.now() + banDuration * 24 * 60 * 60 * 1000).toISOString();
            } else if (banDuration === 0) {
                user.banned = false;
                user.banUntil = null;
            }
            
            saveUsers();
            loadMembers();
            updateMemberSelect();
            
            // تسجيل التحديث في الأرشيف
            addToArchive('update_user', `تحديث بيانات المستخدم ${user.username}`);
            
            alert('تم تحديث بيانات العضو بنجاح');
            
            // تفريغ الحقول
            document.getElementById('newName').value = '';
            document.getElementById('banDuration').value = '';
        }

        function removeUser() {
            const memberId = document.getElementById('memberSelect').value;

            if (!memberId) {
                alert('يرجى اختيار عضو');
                return;
            }

            if (confirm('⚠️ تحذير: هذا الإجراء لا يمكن التراجع عنه! هل أنت متأكد؟')) {
                const user = users.find(u => u.id === memberId);
                if (user) {
                    user.removed = true;
                    user.status = 'offline';
                    saveUsers();
                    loadMembers();
                    updateMemberSelect();

                    // تسجيل الحذف في الأرشيف
                    addToArchive('remove_user', `حذف المستخدم ${user.username} نهائياً`);

                    alert('تم حذف العضو نهائياً');
                }
            }
        }

        function clearAllMessages() {
            if (confirm('هل تريد مسح جميع الرسائل؟ هذا الإجراء لا يمكن التراجع عنه!')) {
                messages = [];
                saveMessages();
                loadMessages();
                
                // تسجيل المسح في الأرشيف
                addToArchive('clear_messages', 'مسح جميع رسائل الدردشة العامة');
                
                alert('تم مسح جميع الرسائل');
            }
        }

        function exportData() {
            const data = {
                users: users,
                messages: messages,
                privateMessages: privateMessages,
                darkChatRooms: darkChatRooms,
                projects: projects,
                userPoints: userPoints,
                systemArchive: systemArchive,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(dataBlob);
            a.download = `shadow-root-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            // تسجيل التصدير في الأرشيف
            addToArchive('export_data', 'تصدير بيانات النظام');
            
            alert('تم تصدير البيانات بنجاح');
        }

        function showSystemInfo() {
            const info = `
                إصدار النظام: Shadow Root v4.0
                تاريخ الإنشاء: ${new Date().toLocaleDateString()}
                عدد المستخدمين: ${users.filter(u => !u.removed).length}
                عدد الرسائل: ${messages.length}
                عدد الدردشات المظلمة: ${darkChatRooms.length}
                عدد المشاريع: ${projects.length}
                المستخدم الحالي: ${currentUser.username}
                رتبة المستخدم: ${getRankName(currentUser.rank)}
                نقاط المستخدم: ${userPoints[currentUser.id] || 0}
                حالة النظام: 🟢 نشط
            `;
            
            alert(info);
        }

        function createDarkRoom() {
            const roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            const newRoom = {
                id: Date.now(),
                code: roomCode,
                creator: currentUser.id,
                members: [currentUser.id],
                messages: [],
                active: true,
                createdAt: new Date().toISOString()
            };
            
            darkChatRooms.push(newRoom);
            saveDarkRooms();
            
            // تسجيل إنشاء الغرفة في الأرشيف
            addToArchive('create_dark_room', `إنشاء غرفة مظلمة جديدة برمز ${roomCode}`);
            
            joinDarkRoomWithCode(roomCode);
        }

        function joinDarkRoom() {
            const roomCode = prompt('أدخل رمز الغرفة:');
            if (roomCode) {
                joinDarkRoomWithCode(roomCode.trim().toUpperCase());
            }
        }

        function joinDarkRoomWithCode(roomCode) {
            const room = darkChatRooms.find(r => r.code === roomCode && r.active);
            
            if (!room) {
                alert('الغرفة غير موجودة أو غير نشطة');
                return;
            }
            
            if (!room.members.includes(currentUser.id)) {
                room.members.push(currentUser.id);
                saveDarkRooms();
                
                // تسجيل الانضمام في الأرشيف
                addToArchive('join_dark_room', `انضمام إلى الغرفة المظلمة ${roomCode}`);
            }
            
            currentDarkRoom = room;
            
            document.getElementById('darkChatRoom').style.display = 'block';
            document.querySelector('.dark-chat-options').style.display = 'none';
            document.getElementById('roomCodeDisplay').textContent = roomCode;
            
            loadDarkChatMessages();
        }

        function leaveDarkRoom() {
            if (currentDarkRoom) {
                const memberIndex = currentDarkRoom.members.indexOf(currentUser.id);
                if (memberIndex !== -1) {
                    currentDarkRoom.members.splice(memberIndex, 1);
                }
                
                if (currentDarkRoom.members.length === 0) {
                    currentDarkRoom.active = false;
                    
                    // تسجيل إغلاق الغرفة في الأرشيف
                    addToArchive('close_dark_room', `إغلاق الغرفة المظلمة ${currentDarkRoom.code}`);
                }
                
                saveDarkRooms();
            }
            
            currentDarkRoom = null;
            document.getElementById('darkChatRoom').style.display = 'none';
            document.querySelector('.dark-chat-options').style.display = 'flex';
        }

        function sendDarkMessage() {
            if (!currentDarkRoom) return;
            
            const messageInput = document.getElementById('darkMessageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText) return;
            
            const message = {
                id: Date.now(),
                userId: currentUser.id,
                userName: currentUser.username,
                text: messageText,
                timestamp: new Date().toISOString()
            };
            
            currentDarkRoom.messages.push(message);
            saveDarkRooms();
            loadDarkChatMessages();
            
            messageInput.value = '';
        }

        function loadDarkChatMessages() {
            if (!currentDarkRoom) return;
            
            const darkChatMessages = document.getElementById('darkChatMessages');
            darkChatMessages.innerHTML = '';
            
            currentDarkRoom.messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.style.background = 'rgba(0, 0, 0, 0.7)';
                messageDiv.style.borderLeft = '4px solid var(--hacker-green)';
                messageDiv.style.color = 'var(--hacker-green)';
                
                const messageHeader = document.createElement('div');
                messageHeader.className = 'message-header';
                
                const senderSpan = document.createElement('span');
                senderSpan.className = 'message-sender';
                senderSpan.textContent = msg.userName;
                senderSpan.style.color = msg.userId === currentUser.id ? 'var(--success)' : 'var(--warning)';
                
                const timeSpan = document.createElement('span');
                timeSpan.textContent = new Date(msg.timestamp).toLocaleTimeString();
                timeSpan.style.color = '#aaa';
                
                messageHeader.appendChild(senderSpan);
                messageHeader.appendChild(timeSpan);
                
                const messageText = document.createElement('div');
                messageText.textContent = msg.text;
                messageText.style.color = 'var(--hacker-green)';
                
                messageDiv.appendChild(messageHeader);
                messageDiv.appendChild(messageText);
                
                darkChatMessages.appendChild(messageDiv);
            });
            
            darkChatMessages.scrollTop = darkChatMessages.scrollHeight;
        }

        function viewAllDarkChats() {
            if (!hasPermission('manage_users')) {
                alert('ليس لديك صلاحية لعرض جميع الدردشات المظلمة');
                return;
            }
            
            const modal = document.getElementById('darkChatsModal');
            const chatsList = document.getElementById('darkChatsList');
            
            chatsList.innerHTML = '';
            
            darkChatRooms.forEach(room => {
                const roomCard = document.createElement('div');
                roomCard.className = 'room-card';
                
                const roomHeader = document.createElement('div');
                roomHeader.className = 'room-header-info';
                
                const roomInfo = document.createElement('div');
                roomInfo.innerHTML = `
                    <strong>الغرفة: ${room.code}</strong>
                    <div style="font-size: 12px; color: #aaa;">
                        المنشئ: ${users.find(u => u.id === room.creator)?.username || 'غير معروف'}
                        | الأعضاء: ${room.members.length}
                        | ${room.active ? '🟢 نشطة' : '🔴 مغلقة'}
                    </div>
                `;
                
                roomHeader.appendChild(roomInfo);
                roomCard.appendChild(roomHeader);
                
                if (room.messages.length > 0) {
                    const roomMessages = document.createElement('div');
                    roomMessages.className = 'room-messages';
                    
                    room.messages.slice(-5).forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'room-message';
                        messageDiv.textContent = `${users.find(u => u.id === msg.userId)?.username || 'غير معروف'}: ${msg.text}`;
                        roomMessages.appendChild(messageDiv);
                    });
                    
                    roomCard.appendChild(roomMessages);
                }
                
                chatsList.appendChild(roomCard);
            });
            
            modal.style.display = 'block';
        }

        function closeDarkChatsModal() {
            document.getElementById('darkChatsModal').style.display = 'none';
        }

        function toggleSecretFeatures() {
            secretMode = !secretMode;
            if (secretMode) {
                document.getElementById('secretFeatures').style.display = 'block';
                document.getElementById('secretBtn').style.backgroundColor = 'var(--system)';
                document.getElementById('secretBtn').style.boxShadow = '0 0 15px var(--system)';
            } else {
                document.getElementById('secretFeatures').style.display = 'none';
                document.getElementById('secretBtn').style.backgroundColor = 'var(--accent)';
                document.getElementById('secretBtn').style.boxShadow = 'var(--shadow)';
            }
        }

        // وظائف نظام التوثيق والنقاط
        function submitProject() {
            const projectName = document.getElementById('projectName').value.trim();
            const projectDescription = document.getElementById('projectDescription').value.trim();
            const projectImages = document.getElementById('projectImages').files;
            
            if (!projectName || !projectDescription) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            // في بيئة حقيقية، سنقوم بتحويل الصور إلى base64
            // هنا سنقوم بمحاكاة العملية
            const images = [];
            for (let i = 0; i < projectImages.length; i++) {
                images.push(`project_image_${i}`);
            }
            
            const project = {
                id: Date.now(),
                userId: currentUser.id,
                userName: currentUser.username,
                name: projectName,
                description: projectDescription,
                images: images,
                status: 'pending',
                verified: false,
                verifiedBy: null,
                verifiedAt: null,
                submittedAt: new Date().toISOString()
            };
            
            projects.push(project);
            saveProjects();
            loadUserProjects();
            
            // تسجيل تقديم المشروع في الأرشيف
            addToArchive('submit_project', `تقديم مشروع جديد: ${projectName}`);
            
            // تفريغ الحقول
            document.getElementById('projectName').value = '';
            document.getElementById('projectDescription').value = '';
            document.getElementById('projectImages').value = '';
            
            alert('تم تقديم المشروع بنجاح! سيتم مراجعته من قبل الإدارة');
        }

        function loadUserProjects() {
            const userProjectsList = document.getElementById('userProjectsList');
            userProjectsList.innerHTML = '';
            
            const userProjects = projects.filter(p => p.userId === currentUser.id);
            
            if (userProjects.length === 0) {
                userProjectsList.innerHTML = '<p style="text-align: center; color: #666;">لا توجد مشاريع مضافة</p>';
                return;
            }
            
            userProjects.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = `project-card ${project.verified ? 'verified' : ''}`;
                
                if (project.verified) {
                    const verifiedBadge = document.createElement('div');
                    verifiedBadge.className = 'verified-badge';
                    verifiedBadge.textContent = 'موثق';
                    projectCard.appendChild(verifiedBadge);
                }
                
                const projectHeader = document.createElement('div');
                projectHeader.innerHTML = `
                    <h4>${project.name}</h4>
                    <div style="font-size: 12px; color: #aaa;">
                        ${new Date(project.submittedAt).toLocaleDateString()} | 
                        ${project.status === 'pending' ? '⏳ قيد المراجعة' : 
                          project.status === 'approved' ? '✅ معتمد' : '❌ مرفوض'}
                    </div>
                `;
                
                const projectDesc = document.createElement('p');
                projectDesc.textContent = project.description;
                projectDesc.style.margin = '10px 0';
                
                projectCard.appendChild(projectHeader);
                projectCard.appendChild(projectDesc);
                
                if (project.images.length > 0) {
                    const projectImages = document.createElement('div');
                    projectImages.className = 'project-images';
                    
                    project.images.forEach(image => {
                        const img = document.createElement('img');
                        img.className = 'project-image';
                        img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231a1a2e"/><text x="50" y="50" font-family="Arial" font-size="10" fill="%2300ff41" text-anchor="middle" dominant-baseline="middle">صورة المشروع</text></svg>';
                        projectImages.appendChild(img);
                    });
                    
                    projectCard.appendChild(projectImages);
                }
                
                userProjectsList.appendChild(projectCard);
            });
            
            // تحميل المشاريع المعلقة للمراجعة (للسستم والمديرين فقط)
            if (hasPermission('manage_users')) {
                loadPendingProjects();
            }
        }

        function loadPendingProjects() {
            const pendingProjectsList = document.getElementById('pendingProjectsList');
            pendingProjectsList.innerHTML = '';
            
            const pendingProjects = projects.filter(p => p.status === 'pending');
            
            if (pendingProjects.length === 0) {
                pendingProjectsList.innerHTML = '<p style="text-align: center; color: #666;">لا توجد مشاريع معلقة</p>';
                return;
            }
            
            pendingProjects.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = 'project-card';
                
                const projectHeader = document.createElement('div');
                projectHeader.innerHTML = `
                    <h4>${project.name}</h4>
                    <div style="font-size: 12px; color: #aaa;">
                        من: ${project.userName} | 
                        ${new Date(project.submittedAt).toLocaleDateString()}
                    </div>
                `;
                
                const projectDesc = document.createElement('p');
                projectDesc.textContent = project.description;
                projectDesc.style.margin = '10px 0';
                
                projectCard.appendChild(projectHeader);
                projectCard.appendChild(projectDesc);
                
                if (project.images.length > 0) {
                    const projectImages = document.createElement('div');
                    projectImages.className = 'project-images';
                    
                    project.images.forEach(image => {
                        const img = document.createElement('img');
                        img.className = 'project-image';
                        img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231a1a2e"/><text x="50" y="50" font-family="Arial" font-size="10" fill="%2300ff41" text-anchor="middle" dominant-baseline="middle">صورة المشروع</text></svg>';
                        projectImages.appendChild(img);
                    });
                    
                    projectCard.appendChild(projectImages);
                }
                
                const projectActions = document.createElement('div');
                projectActions.style.marginTop = '15px';
                projectActions.style.display = 'flex';
                projectActions.style.gap = '10px';
                
                const approveBtn = document.createElement('button');
                approveBtn.className = 'btn btn-success';
                approveBtn.textContent = 'موافقة';
                approveBtn.onclick = function() {
                    approveProject(project.id);
                };
                
                const rejectBtn = document.createElement('button');
                rejectBtn.className = 'btn btn-danger';
                rejectBtn.textContent = 'رفض';
                rejectBtn.onclick = function() {
                    rejectProject(project.id);
                };
                
                projectActions.appendChild(approveBtn);
                projectActions.appendChild(rejectBtn);
                
                projectCard.appendChild(projectActions);
                
                pendingProjectsList.appendChild(projectCard);
            });
        }

        function approveProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (project) {
                project.status = 'approved';
                project.verified = true;
                project.verifiedBy = currentUser.id;
                project.verifiedAt = new Date().toISOString();
                
                // منح نقاط للمستخدم
                addUserPoints(project.userId, 15);
                
                saveProjects();
                loadUserProjects();
                loadPointsData();
                
                // تسجيل الموافقة في الأرشيف
                addToArchive('approve_project', `موافقة على مشروع ${project.name} للمستخدم ${project.userName}`);
                
                alert('تم توثيق المشروع بنجاح! تم منح 15 نقطة للمستخدم');
            }
        }

        function rejectProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (project) {
                project.status = 'rejected';
                saveProjects();
                loadUserProjects();
                
                // تسجيل الرفض في الأرشيف
                addToArchive('reject_project', `رفض مشروع ${project.name} للمستخدم ${project.userName}`);
                
                alert('تم رفض المشروع');
            }

            // تحميل المشاريع الموثقة لعرضها للجميع
            function loadVerifiedProjects() {
                const verifiedList = document.getElementById('verifiedProjectsList');
                if (!verifiedList) return;
                verifiedList.innerHTML = '';

                const verified = projects.filter(p => p.verified === true);
                if (verified.length === 0) {
                    verifiedList.innerHTML = '<p style="color:#aaa">لا توجد مشاريع موثقة بعد</p>';
                    return;
                }

                verified.slice().reverse().forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'project-card';
                    card.style.cursor = 'pointer';
                    card.innerHTML = `<strong>${p.name}</strong> — ${p.userName} <div style="color:#aaa; font-size:12px">${new Date(p.submittedAt).toLocaleDateString()}</div>`;
                    card.onclick = function() {
                        const modal = document.getElementById('projectDetailsModal');
                        const title = document.getElementById('projectDetailsTitle');
                        const content = document.getElementById('projectDetailsContent');
                        title.textContent = `${p.name} — ${p.userName}`;
                        content.innerHTML = `<p>${p.description}</p>`;
                        modal.style.display = 'block';
                    };
                    verifiedList.appendChild(card);
                });
            }

            // Export / Import helpers so a user can move their data between devices
            function exportDataBackup() {
                const payload = {
                    users, messages, privateMessages, darkChatRooms, projects, userPoints, systemArchive, pendingPromotions, privateUnread
                };
                const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `shadow-root-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            }

            function importDataBackup(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        // Merge users and projects and other structures safely
                        if (Array.isArray(data.users)) {
                            data.users.forEach(u => {
                                if (!users.find(x => x.id === u.id)) users.push(u);
                            });
                        }
                        if (Array.isArray(data.projects)) {
                            data.projects.forEach(p => {
                                if (!projects.find(x => x.id === p.id)) projects.push(p);
                            });
                        }
                        if (data.userPoints) {
                            // Merge userPoints but keep existing entries (including zeros).
                            Object.keys(data.userPoints).forEach(k => {
                                if (!(k in userPoints)) userPoints[k] = data.userPoints[k];
                            });
                        }
                        if (Array.isArray(data.pendingPromotions)) {
                            data.pendingPromotions.forEach(pp => { if (!pendingPromotions.find(x=>x.id===pp.id)) pendingPromotions.push(pp); });
                        }
                        if (data.privateUnread) {
                            Object.keys(data.privateUnread).forEach(fromId => {
                                if (!privateUnread[fromId]) privateUnread[fromId] = {};
                                Object.keys(data.privateUnread[fromId]).forEach(toId => {
                                    if (!(toId in privateUnread[fromId])) privateUnread[fromId][toId] = data.privateUnread[fromId][toId];
                                });
                            });
                        }

                        saveUsers(); saveProjects(); saveUserPoints(); savePendingPromotions();
                        loadMembers(); loadUserProjects(); renderPendingPromotions(); loadVerifiedProjects();
                        alert('تم استيراد البيانات ودمجها بنجاح');
                    } catch (err) {
                        alert('فشل استيراد الملف: صيغة غير صحيحة');
                    }
                };
                reader.readAsText(file);
            }
        }

        function loadPointsData() {
            // تحديث نقاط المستخدم الحالي
            document.getElementById('userPointsValue').textContent = userPoints[currentUser.id] || 0;
            document.getElementById('userPoints').textContent = `النقاط: ${userPoints[currentUser.id] || 0}`;
            
            // تحديث مستوى المستخدم
            const points = userPoints[currentUser.id] || 0;
            let level = 'مبتدئ';
            let badgeClass = 'badge-1';
            
            if (points >= 100) {
                level = 'أسطوري';
                badgeClass = 'badge-6';
            } else if (points >= 50) {
                level = 'محترف';
                badgeClass = 'badge-5';
            } else if (points >= 30) {
                level = 'متقدم';
                badgeClass = 'badge-4';
            } else if (points >= 15) {
                level = 'متوسط';
                badgeClass = 'badge-3';
            } else if (points >= 5) {
                level = 'مبتدئ متقدم';
                badgeClass = 'badge-2';
            }
            
            document.getElementById('userLevel').textContent = `المستوى: ${level}`;
            
            // تحديث شارات المستخدم
            const userBadges = document.getElementById('userBadges');
            userBadges.innerHTML = '';
            
            const badge = document.createElement('div');
            badge.className = `points-badge ${badgeClass}`;
            badge.textContent = level;
            userBadges.appendChild(badge);
            
            // تحديث تصنيف النقاط
            loadPointsLeaderboard();
        }

        function loadPointsLeaderboard() {
            const pointsLeaderboard = document.getElementById('pointsLeaderboard');
            pointsLeaderboard.innerHTML = '';
            
            // إنشاء مصفوفة من المستخدمين مع نقاطهم
            const usersWithPoints = users
                .filter(user => !user.removed)
                .map(user => ({
                    id: user.id,
                    username: user.username,
                    points: userPoints[user.id] || 0,
                    rank: user.rank
                }))
                .sort((a, b) => b.points - a.points);
            
            if (usersWithPoints.length === 0) {
                pointsLeaderboard.innerHTML = '<p style="text-align: center; color: #666;">لا توجد بيانات</p>';
                return;
            }
            
            usersWithPoints.forEach((user, index) => {
                const leaderboardItem = document.createElement('div');
                leaderboardItem.className = 'leaderboard-item';
                
                const userInfo = document.createElement('div');
                userInfo.innerHTML = `
                    <span class="leaderboard-rank">#${index + 1}</span>
                    ${user.username}
                    <span class="user-badge badge-${getBadgeLevel(user.points)}">${getRankName(user.rank)}</span>
                `;
                
                const userPointsEl = document.createElement('div');
                userPointsEl.textContent = user.points;
                userPointsEl.style.color = 'var(--hacker-green)';
                userPointsEl.style.fontWeight = 'bold';
                
                leaderboardItem.appendChild(userInfo);
                leaderboardItem.appendChild(userPointsEl);
                
                pointsLeaderboard.appendChild(leaderboardItem);
            });
        }

        function updatePointsUserSelect() {
            const pointsUserSelect = document.getElementById('pointsUserSelect');
            pointsUserSelect.innerHTML = '<option value="">-- اختر مستخدم --</option>';
            
            users.forEach(user => {
                if (!user.removed && user.id !== currentUser.id) {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.username} (${getRankName(user.rank)}) - ${userPoints[user.id] || 0} نقطة`;
                    pointsUserSelect.appendChild(option);
                }
            });
        }

        function addPoints() {
            const userId = document.getElementById('pointsUserSelect').value;
            const pointsAmount = Number(document.getElementById('pointsAmount').value);

            if (!userId || isNaN(pointsAmount) || pointsAmount <= 0) {
                alert('يرجى اختيار مستخدم وإدخال عدد نقاط صحيح');
                return;
            }

            addUserPoints(userId, pointsAmount);
            document.getElementById('pointsAmount').value = '';
            
            // تسجيل إضافة النقاط في الأرشيف
            addToArchive('add_points', `إضافة ${pointsAmount} نقطة للمستخدم ${users.find(u => u.id === userId)?.username}`);
            
            alert('تم إضافة النقاط بنجاح');
        }

        function removePoints() {
            const userId = document.getElementById('pointsUserSelect').value;
            const pointsAmount = parseInt(document.getElementById('pointsAmount').value);
            
            if (!userId || isNaN(pointsAmount) || pointsAmount <= 0) {
                alert('يرجى اختيار مستخدم وإدخال عدد نقاط صحيح');
                return;
            }
            
            const currentPoints = userPoints[userId] || 0;
            userPoints[userId] = Math.max(0, currentPoints - pointsAmount);
            saveUserPoints();
            loadPointsData();
            updatePointsUserSelect();
            
            document.getElementById('pointsAmount').value = '';
            
            // تسجيل خصم النقاط في الأرشيف
            addToArchive('remove_points', `خصم ${pointsAmount} نقطة من المستخدم ${users.find(u => u.id === userId)?.username}`);
            
            alert('تم خصم النقاط بنجاح');
        }

        function resetPoints() {
            const userId = document.getElementById('pointsUserSelect').value;
            
            if (!userId) {
                alert('يرجى اختيار مستخدم');
                return;
            }
            
            if (confirm('هل تريد إعادة تعيين نقاط هذا المستخدم إلى الصفر؟')) {
                userPoints[userId] = 0;
                saveUserPoints();
                loadPointsData();
                updatePointsUserSelect();
                
                // تسجيل إعادة التعيين في الأرشيف
                addToArchive('reset_points', `إعادة تعيين نقاط المستخدم ${users.find(u => u.id === userId)?.username}`);
                
                alert('تم إعادة تعيين النقاط بنجاح');
            }
        }

        function addUserPoints(userId, points) {
            if (!userId) return;

            const prev = Number(userPoints[userId] || 0);
            const delta = Number(points || 0);
            userPoints[userId] = prev + delta;
            saveUserPoints();
            loadPointsData();
            updatePointsUserSelect();

            // Quick visual feedback
            try {
                const notice = document.createElement('div');
                notice.textContent = `تمت إضافة ${delta} نقاط للمستخدم`;
                notice.style.position = 'fixed';
                notice.style.bottom = '20px';
                notice.style.left = '20px';
                notice.style.background = 'rgba(0,0,0,0.8)';
                notice.style.color = 'var(--hacker-green)';
                notice.style.padding = '8px 12px';
                notice.style.borderRadius = '6px';
                document.body.appendChild(notice);
                setTimeout(() => notice.remove(), 1800);
            } catch (e) {
                /* ignore UI feedback errors */
            }
        }

        function awardDailyLoginPoints() {
            const today = new Date().toDateString();
            
            if (dailyLogin[currentUser.id] !== today) {
                // منح نقاط الدخول اليومي
                addUserPoints(currentUser.id, 3);
                dailyLogin[currentUser.id] = today;
                saveDailyLogin();
                
                // تسجيل الدخول اليومي في الأرشيف
                addToArchive('daily_login', `الدخول اليومي للمستخدم ${currentUser.username} - +3 نقاط`);
            }
        }

        function getBadgeLevel(points) {
            if (points >= 100) return 6;
            if (points >= 50) return 5;
            if (points >= 30) return 4;
            if (points >= 15) return 3;
            if (points >= 5) return 2;
            return 1;
        }

        // وظائف مساعدة جديدة
        function showVerificationTab() {
            document.querySelector('.tab[data-tab="verification"]').click();
        }

        function showPointsTab() {
            document.querySelector('.tab[data-tab="points"]').click();
        }

        function showArchiveTab() {
            document.querySelector('.tab[data-tab="archive"]').click();
        }

        function showEarthFeatures() {
            if (currentUser.rank === 'system') {
                earthControl();
            } else {
                alert('هذه الميزة متاحة فقط لرتبة SYSTEM');
            }
        }

        function showAdminTools() {
            const adminTabBtn = document.querySelector('.tab[data-tab="admin"]');
            if (adminTabBtn) adminTabBtn.click();
            // scroll to admin area
            setTimeout(() => {
                const adminArea = document.getElementById('adminTab');
                if (adminArea) adminArea.scrollIntoView({behavior: 'smooth', block: 'start'});
            }, 120);
        }

        function showSystemTools() {
            const adminTabBtn = document.querySelector('.tab[data-tab="admin"]');
            if (adminTabBtn) adminTabBtn.click();
            // scroll to system tools card specifically
            setTimeout(() => {
                const sysCard = document.getElementById('systemToolsCard');
                if (sysCard) {
                    sysCard.style.display = 'block';
                    sysCard.scrollIntoView({behavior: 'smooth', block: 'center'});
                }
            }, 150);
        }

        // وظائف الواجهة التي تحتاج إلى إكمال
        function systemBroadcast() {
            sendSystemBroadcast();
        }

        // Register service worker for offline support (works when served over HTTP)
        if ('serviceWorker' in navigator) {
            try {
                navigator.serviceWorker.register('/sw.js').then(reg => {
                    console.log('Service worker registered', reg);
                }).catch(err => console.warn('SW register failed', err));
            } catch (e) {
                console.warn('SW not available', e);
            }
        }
    </script>
</body>
</html>


